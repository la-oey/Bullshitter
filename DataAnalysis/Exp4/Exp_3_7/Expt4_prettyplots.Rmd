---
title: "Expt4_prettyplots"
author: "Lauren Oey"
date: "6/17/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(forcats)
library(plotly)
library(ggthemes)
library(lme4)
library(gridExtra)
library(plot3D)
library(cowplot)
library(stats4)
library(scales)
library(grid)
source("lying_modelFunctions.R")
knitr::opts_chunk$set(echo = TRUE)

# expt4 <- read.csv("bsfinal_expt4.csv")
# expt4 <- mutate(expt4, expt = "expt4")
# expt5 <- read.csv("bsfinal_expt5.csv")
# expt5 <- mutate(expt5, expt = "expt5")
# bs.final <- bind_rows(expt4, expt5) %>%
#   mutate(expt = as.factor(expt),
#          subjID = as.factor(paste0("subj",str_pad(group_indices(.,subjID),3,pad="0"))))
# write.csv(bs.final, "bsfinal_anon.csv")

bs.final <- read.csv("bsfinal_anon.csv")

## old model files
df.unif_expt4 <- read_csv("sims_varyMorality_expt4_alph0.25.csv")
df.unif_expt4 <- mutate(df.unif_expt4, expt = "expt4")
moralityResponseToIdiot_expt4 <- read_csv("sims_varyMorality_liarResponseToIdiot_expt4_alph0.25.csv")
moralityResponseToIdiot_expt4 <- mutate(moralityResponseToIdiot_expt4, expt = "expt4")
df.unif_expt5 <- read_csv("sims_varyMorality_expt5_alph0.25.csv")
df.unif_expt5 <- mutate(df.unif_expt5, expt = "expt5")
moralityResponseToIdiot_expt5 <- read_csv("sims_varyMorality_liarResponseToIdiot_expt5_alph0.25.csv")
moralityResponseToIdiot_expt5 <- mutate(moralityResponseToIdiot_expt5, expt = "expt5")
df.unif <- bind_rows(df.unif_expt4, df.unif_expt5) %>%
  mutate(expt = as.factor(expt))

## new model files
noToM_sender <- read_csv("lie-models/noToM_sender_prior0.5.csv")
noToM_receiver <- read_csv("lie-models/noToM_receiver_prior0.5.csv")
recursiveToM_sender <- read_csv("lie-models/recursiveToM_sender_prior0.5.csv")
recursiveToM_receiver <- read_csv("lie-models/recursiveToM_receiver_prior0.5.csv")

indiv.sender <- read_csv("individual_sender.csv")



moralityResponseToIdiot <- bind_rows(moralityResponseToIdiot_expt4, moralityResponseToIdiot_expt5) %>%
  mutate(expt = as.factor(expt))

# one sided 2 sample t test with pooled variance
wald.z.test <- function(m1, sd1, m2, sd2){
  z <- (m1 - m2) / sqrt(sd1^2 + sd2^2)
  p <- pnorm(abs(z), lower.tail=F)
  return(data.frame(m1, sd1, m2, sd2, z, p))
}

condColors.diff = c("p = 0.2" = "blue3",
                    "p = 0.5" = "purple3",
                    "p = 0.8" = "red3")

plotTitleSize = 9.5
axisTitleSize = 9
axisTextSize = 7.5
marginDim = margin(2,1,0,2)
marginAxisX = margin(-1,0,-3.5,0)
axisLineColour = "gray40"
alphaLine = 0.8
lineSize = 0.9
ablineSize = 0.8
axisLineSize = 0.5



my_red = c("#ffd5d6","#fc7f81","#fd2428")

p_label = c(
  "p = 0.2" = "20% red",
  "p = 0.5" = "50% red",
  "p = 0.8" = "80% red"
)

outlinecolor = "black"
strokesize = 0.25
```




```{r}
stdErrLiar = function(morVal, datafr){
  prediction <- datafr %>%
    filter(role == "Liar", mor == morVal) %>%
    mutate(probabilityRed = p,
           drawnRed = ks,
           predicted = val) %>%
    select(expt, probabilityRed, drawnRed, predicted)
  real <- bs.final %>%
    filter(roleCurrent == "bullshitter") %>%
    select(expt, probabilityRed, drawnRed, reportedDrawn)
  left_join(real, prediction, by=c("expt", "probabilityRed", "drawnRed")) %>%
    mutate(error = reportedDrawn - predicted) %>%
    summarise(n = n(),
              residsum = sum(error^2),
              stderror = sqrt(residsum/n)) %>%
    .$stderror
}

stdErrDetector = function(morVal, datafr){
  prediction <- datafr %>%
    filter(role == "Detector", mor == morVal) %>%
    mutate(probabilityRed = p,
           reportedDrawn = ks,
           predicted = val) %>%
    select(expt, probabilityRed, reportedDrawn, predicted)
  real <- bs.final %>%
    filter(roleCurrent == "bullshitDetector") %>%
    select(expt, probabilityRed, reportedDrawn, callBS) %>%
    mutate(callBS = ifelse(callBS=="True", 1, 0))
  left_join(real, prediction, by=c("expt", "probabilityRed", "reportedDrawn")) %>%
    mutate(error = callBS - predicted) %>%
    summarise(n = n(),
              residsum = sum(error^2),
              stderror = sqrt(residsum/n)) %>%
    .$stderror
}

m.df <- data.frame(mor = min(df.unif$mor):max(df.unif$mor)) %>%
  mutate(stderrLieMorality = sapply(mor, stdErrLiar, df.unif),
         stderrDetectMorality = sapply(mor, stdErrDetector, df.unif),
         stderrLieMoralityIdiot = sapply(mor, stdErrLiar, moralityResponseToIdiot)) %>%
  drop_na()

m.df %>%
  filter(stderrLieMorality == min(stderrLieMorality) | 
           stderrDetectMorality == min(stderrDetectMorality) | 
           stderrLieMoralityIdiot == min(stderrLieMoralityIdiot))
m.df

lieMoral = 20
detectMoral = 8
```

```{r}
m.df
# Plot std err across lying penalties
m.df %>%
  ggplot() +
  geom_point(aes(x=mor, y=stderrLieMorality), colour="red") +
  geom_line(aes(x=mor, y=stderrLieMorality), colour="red") +
  geom_point(filter(m.df, stderrLieMorality==min(stderrLieMorality)), mapping=aes(x=mor, y=stderrLieMorality), colour="darkred") +
  geom_point(aes(x=mor, y=stderrDetectMorality*4), colour="lightblue") +
  geom_line(aes(x=mor, y=stderrDetectMorality*4), colour="lightblue") +
  geom_point(filter(m.df, stderrDetectMorality==min(stderrDetectMorality)), mapping=aes(x=mor, y=stderrDetectMorality*4), colour="blue") +
  scale_y_continuous("Std Err Lie Morality", limits=c(1.5,2.5), 
                     sec.axis=sec_axis(~.*.25, name="Std Err Detect Morality")) +
  theme_minimal()
```

```{r}
df.unif

residSumLiar = function(morVal){
  prediction <- df.unif %>%
    filter(role == "Liar", mor == morVal) %>%
    mutate(probabilityRed = p,
           drawnRed = ks,
           predicted = val) %>%
    select(expt, probabilityRed, drawnRed, predicted)
  real <- bs.final %>%
    filter(roleCurrent == "bullshitter") %>%
    select(expt, probabilityRed, drawnRed, reportedDrawn)
  left_join(real, prediction, by=c("expt", "probabilityRed", "drawnRed")) %>%
    mutate(error = reportedDrawn - predicted) %>%
    summarise(n = n(),
              residsum = sum(error^2),
              loglik = -(n/2)*log(residsum/n)) %>%
    .$loglik
}

residSumDetector = function(morVal){
  prediction <- df.unif %>%
    filter(role == "Detector", mor == morVal) %>%
    mutate(probabilityRed = p,
           reportedDrawn = ks,
           predicted = val) %>%
    select(expt, probabilityRed, reportedDrawn, predicted)
  real <- bs.final %>%
    filter(roleCurrent == "bullshitDetector") %>%
    select(expt, probabilityRed, reportedDrawn, callBS) %>%
    mutate(callBS = ifelse(callBS=="True", 1, 0))
  left_join(real, prediction, by=c("expt", "probabilityRed", "reportedDrawn")) %>%
    mutate(error = callBS - predicted) %>%
    summarise(n = n(),
              residsum = sum(error^2),
              loglik = -(n/2)*log(residsum/n)) %>%
    .$loglik
}


likelihood.df <- data.frame(mor = min(df.unif$mor):max(df.unif$mor)) %>%
  mutate(ll.lie = mapply(residSumLiar, mor),
         ll.detect = mapply(residSumDetector, mor)) %>%
  drop_na()


ggplot(likelihood.df) +
  geom_point(aes(x=mor, y=ll.lie), colour="red") +
  geom_line(aes(x=mor, y=ll.lie), colour="red") +
  geom_point(aes(x=mor, y=ll.detect), colour="lightblue") +
  geom_line(aes(x=mor, y=ll.detect), colour="lightblue") +
  scale_y_continuous("Log Likelihood Lie Morality", 
                     sec.axis=sec_axis(~.*1, name="Std Err Detect Morality")) +
  theme_minimal()

filter(likelihood.df, ll.detect==max(likelihood.df$ll.detect))
filter(likelihood.df, ll.lie==max(likelihood.df$ll.lie))


ll.lie.df.prev <- likelihood.df %>%
  filter(mor >= 19 & mor <= 20) %>%
  mutate(mor=mor+1,
         ll.lie.prev = ll.lie) %>%
  select(mor, ll.lie.prev)
ll.lie.A <- likelihood.df %>%
  filter(mor >= 20 & mor <= 21) %>%
  select(mor, ll.lie) %>%
  left_join(ll.lie.df.prev) %>%
  mutate(diff.bw = -ll.lie-(-ll.lie.prev)) %>%
  summarise(diff = diff(diff.bw)) %>%
  .$diff

ll.detect.df.prev <- likelihood.df %>%
  filter(mor >= 7 & mor <= 8) %>%
  mutate(mor=mor+1,
         ll.detect.prev = ll.detect) %>%
  select(mor, ll.detect.prev)
ll.detect.A <- likelihood.df %>%
  filter(mor >= 8 & mor <= 9) %>%
  select(mor, ll.detect) %>%
  left_join(ll.detect.df.prev) %>%
  mutate(diff.bw = -ll.detect-(-ll.detect.prev)) %>%
  summarise(diff = diff(diff.bw)) %>%
  .$diff

(se.lie.A = sqrt(1/ll.lie.A))
(se.detect.A = sqrt(1/ll.detect.A))

data.frame(role = c("sender", "receiver"),
           estimate = c(20, 8),
           std.err = c(se.lie.A, se.detect.A)) %>%
  mutate(lower = estimate-std.err,
         upper = estimate+std.err) %>%
  ggplot(aes(x=role, y=estimate)) +
  geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=lower, ymax=upper))

wald.z.test(20, se.lie.A, 8, se.detect.A)
```

# Pretty Plots

## Recursive Inference Model

```{r}
# Recursive Model w/ Morality Penalty

lie.recurse.moral <- df.unif %>%
  filter(role=="Liar", mor==lieMoral, expt=="expt4") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_abline(size=ablineSize, intercept = 0, slope = 1, colour="darkgray", linetype=2) +
  geom_line(size=lineSize, alpha=alphaLine) +
  ggtitle("Recursive+Aversion") +
  scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.recurse.moral
ggsave("img/modelRecurse_lie_moral.png", lie.recurse.moral, height=2.5, width=3)

detect.recurse.moral <- df.unif %>%
  filter(role=="Detector", mor==detectMoral, expt=="expt4") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.recurse.moral
ggsave("img/modelRecurse_detect_moral.png", detect.recurse.moral, height=8, width=7.5)
```



```{r}
lie.recurse.nomoral <- df.unif %>%
  filter(role=="Liar", mor==0, expt=="expt4") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_abline(size=ablineSize, intercept = 0, slope = 1, colour="darkgray", linetype=2) +
  geom_line(size=lineSize, alpha=alphaLine) +
  ggtitle("Recursive") +
  scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.recurse.nomoral
ggsave("img/modelRecurse_lie_nomoral.png", lie.recurse.nomoral, height=8, width=7.5)

detect.recurse.nomoral <- df.unif %>%
  filter(role=="Detector", mor==0, expt=="expt4") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.recurse.nomoral
ggsave("img/modelRecurse_detect_nomoral.png", detect.recurse.nomoral, height=8, width=7.5)
```






## Response to Idiot Liar/Lie Detector

```{r}
moral = lieMoral
Expt = 4
LIE <- 1-diag(numMarbles+1)
mat.idiotLiar <- matrix(rep(1/11,11*11), nrow=11)
P.K <- matrix(rep(p.k(0:10, 0.2), each=10+1), nrow=10+1)
lie0.2idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.2idiot <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2idiot)

P.K <- matrix(rep(p.k(0:10, 0.5), each=10+1), nrow=10+1)
lie0.5idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.5idiot <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5idiot)

P.K <- matrix(rep(p.k(0:10, 0.8), each=10+1), nrow=10+1)
lie0.8idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.8idiot <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8idiot)

detect.respondToIdiot <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           ksay=rep(0:10,3),
           bs=c(detect0.2idiot, detect0.5idiot, detect0.8idiot)) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=ksay, y=bs, colour=probabilityRed.txt)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  # scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  # scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_x_continuous("Reported Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff)+
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,-1,0,-2.5)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.respondToIdiot
#ggsave("img/modelRespondToIdiot_detect.png", detect.respondToIdiot, height=8, width=7.5)           

avgPropBS <- bs.final %>%
  filter(roleCurrent == "bullshitDetector") %>%
  summarise(propBS = sum(callBS == "True")/n()) %>%
  .$propBS
bonddepaulo <- 1-.56
vrij <- 1 - .615
lie.respondToIdiot <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           k=rep(0:10,3),
           ksay=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                  exp.ksay(0.8, rep(bonddepaulo, 11)))) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=k, y=ksay, colour=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_line(size=lineSize, alpha=alphaLine) +
  # ggtitle("Uniform + Moral") +
  ggtitle("Uniform Opponent") +
  # scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  # scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_x_continuous("True Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,-1,0,3.8)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.respondToIdiot
#ggsave("img/modelRespondToIdiot_lie.png", lie.respondToIdiot, height=8, width=7.5)  
```

## Response to Idiot Liar/Lie Detector Without Morality

```{r}
moral = 0
Expt = 4
detect0.2idiot.nomoral <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2idiot)
detect0.5idiot.nomoral <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5idiot)
detect0.8idiot.nomoral <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8idiot)

detect.respondToIdiot.nomoral <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           ksay=rep(0:10,3),
           bs=c(detect0.2idiot, detect0.5idiot, detect0.8idiot)) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=ksay, y=bs, colour=probabilityRed.txt)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  # scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  # scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_x_continuous("Reported Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff)+
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,-1,0,-2.5)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.respondToIdiot.nomoral
ggsave("img/modelRespondToIdiot_detect_nomoral.png", detect.respondToIdiot.nomoral, height=8, width=7.5)           

lie.respondToIdiot.nomoral <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           k=rep(0:10,3),
           ksay=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                  exp.ksay(0.8, rep(bonddepaulo, 11)))) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=k, y=ksay, colour=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_line(size=lineSize, alpha=alphaLine) +
  # ggtitle("Uniform + Moral") +
  ggtitle("Random Opponent") +
  # scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  # scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_x_continuous("True Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,-1,0,3.8)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.respondToIdiot.nomoral
ggsave("img/modelRespondToIdiot_lie_nomoral.png", lie.respondToIdiot.nomoral, height=8, width=7.5)  
moral = lieMoral
```

```{r}
lie.results_expt4 <- bs.final %>%
  filter(roleCurrent == "bullshitter", expt=="expt4") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, drawnRed) %>%
  summarise(mean = mean(reportedDrawn),
            sd = sd(reportedDrawn),
            se = sd/sqrt(n()),
            n=n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=drawnRed, y=mean, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha=0.3) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_point(pch=21, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  ggtitle("Red Payoff") +
  #scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  #scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values = condColors.diff) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5)), colour="none") +
  theme_minimal() +
  theme(legend.position="none",
        legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.results_expt4
ggsave("img/results_lie_expt4.png", lie.results_expt4, height=2.5, width=3)

detect.results_expt4 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt4") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, expt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_ribbon(aes(ymin=prop-se, ymax=prop+se), alpha=0.3) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_point(pch=21, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  #scale_x_continuous("", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  #scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Receiver Prop. BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  scale_fill_manual(values = condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.results_expt4
ggsave("img/results_detect_expt4.png", detect.results_expt4, height=2.5, width=3)
```

```{r}
lie.results_expt5 <- bs.final %>%
  filter(roleCurrent == "bullshitter", expt=="expt5") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, drawnRed) %>%
  summarise(mean = mean(reportedDrawn),
            sd = sd(reportedDrawn),
            se = sd/sqrt(n()),
            n=n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=drawnRed, y=mean, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha=0.3) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_point(pch=21, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  ggtitle("Blue Payoff") +
  scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values = condColors.diff) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5)), colour="none") +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.results_expt5 + theme(legend.position="none")
ggsave("img/results_lie_expt5.png", lie.results_expt5, height=2.5, width=3)

detect.results_expt5 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt5") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_ribbon(aes(ymin=prop-se, ymax=prop+se), alpha=0.3) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_point(pch=21, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  scale_x_continuous("", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  scale_fill_manual(values = condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.results_expt5
ggsave("img/results_detect_expt5.png", detect.results_expt5, height=2.5, width=3)
```

# Combine Graphs
```{r}
legend <- get_legend(lie.results_expt5)

lieplots <- plot_grid(#lie.idiot,
                      lie.respondToIdiot.nomoral,
                      #lie.respondToIdiot,
                      #lie.respondToHumanData,
                      lie.recurse.nomoral,
                      lie.recurse.moral,
                      lie.results_expt4,
                      lie.results_expt5 + theme(legend.position="none"), 
                      nrow=1,
                      rel_widths=c(10.92, 10, 10, 10, 10)) #10.72 with 4 panels

detectplots <- plot_grid(#detect.idiot, 
                         detect.respondToIdiot.nomoral,
                         #detect.respondToIdiot, 
                         #detect.respondToHumanData, 
                         detect.recurse.nomoral, 
                         detect.recurse.moral, 
                         detect.results_expt4,
                         detect.results_expt5, 
                         nrow=1,
                         rel_widths=c(10.92, 10, 10, 10, 10))

liarLabel <- ggdraw() +
  draw_label("Sender", fontface="bold", size=12, y=0.87, x=0.5, hjust=0, angle=270)

lierow <- plot_grid(lieplots, liarLabel, nrow=1, rel_widths=c(96, 4))

detectorLabel <- ggdraw() +
  draw_label("Receiver", fontface="bold", size=12, y=0.99, x=0.5, hjust=0, angle=270)

detectrow <- plot_grid(detectplots, detectorLabel, nrow=1, rel_widths=c(96, 4))

allplots <- plot_grid(lierow, 
                      detectrow, 
                      nrow=2,
                      #rel_heights=c(0.53, 0.47))
                      rel_heights=c(0.538, 0.462))

withLegend <- ggdraw() +
  draw_plot(allplots) +
  draw_plot(legend, x=0.415, y=0.16)

# ggsave("img/allPredictions_wExpt5.pdf", 
#        withLegend, 
#        units="cm", height=8.5, width=17.8)

withLegend
ggsave("img/allPredictions_wExpt5.pdf", 
       withLegend, 
       units="cm", height=7.3, width=17.8)

# ggsave("img/allPredictions_wExpt5_nolegend.png", 
#        allplots, 
#        units="cm", height=7.3, width=17.8)


detectplots_nomoral <- plot_grid(detect.respondToIdiot.nomoral + ggtitle("Random Opponent") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
                         detect.recurse.nomoral + ggtitle("Recursive") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         detect.results_expt4 + ggtitle("Red Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
                         detect.results_expt5 + ggtitle("Blue Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         nrow=1,
                         rel_widths=c(10.72, 10, 10, 10))


detectrow_nomoral <- plot_grid(detectplots_nomoral, detectorLabel, nrow=1, rel_widths=c(96, 4))

withLegend_nomoral <- ggdraw() +
  draw_plot(detectrow_nomoral) +
  draw_plot(legend, x=0.415, y=0.32) 
ggsave("img/detectPredictions.pdf", 
       withLegend_nomoral, 
       units="cm", height=4.7, width=17.8)
```




```{r}
detectplots_results <- plot_grid(detect.results_expt4 + ggtitle("Red Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
                         detect.results_expt5 + ggtitle("Blue Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         nrow=1,
                         rel_widths=c(11.32, 10))

detectorLabel <- ggdraw() +
  draw_label("Receiver", fontface="bold", size=12, y=0.85, x=0.5, hjust=0, angle=270)

detectrow_results <- plot_grid(detectplots_results, detectorLabel, nrow=1, rel_widths=c(94, 6))

withLegend_results <- ggdraw() +
  draw_plot(detectrow_results) +
  draw_plot(legend, x=0.35, y=0.31) 
ggsave("img/detectResults.pdf", 
       withLegend_results, 
       units="cm", height=4.3, width=8.7)
```

```{r}
bs.final %>%
  filter(roleCurrent == "bullshitter", expt=="expt4") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, drawnRed, reportedDrawn) %>%
  summarise(n=n())

p <- plot_ly(z = ~volcano) %>% add_surface()
```








# Model vs Human Comparison

```{r}
modelColors = c("random opponent"="chocolate2",
                "uniform+aversion"="firebrick3",
                "recursive "="goldenrod1", 
                "recursive+aversion"="forestgreen") #breaks if no space after "recursive"

pShapes = c("p = 0.2" = 21,
            "p = 0.5" = 22,
            "p = 0.8" = 24
)

prob_to_logit <- function(p){
  log(p/(1-p))
}

modelLieComp <- df.unif %>%
  filter(role=="Liar", mor==lieMoral) %>%
  mutate(model = "recursive+aversion", 
         k = ks,
         mean.model = val,
         se.model = se) %>%
  select(role, model, p, k, expt, mean.model, se.model)

modelDetectComp <- df.unif %>%
  filter(role=="Detector", mor==detectMoral) %>%
  mutate(model = "recursive+aversion", 
         k = ks,
         mean.model = val,
         se.model = se) %>%
  select(role, model, p, k, expt, mean.model, se.model)

rationalLieComp <- df.unif %>%
  filter(role=="Liar", mor==0) %>%
  mutate(model = "recursive ", 
         k = ks,
         mean.model = val,
         se.model = se) %>%
  select(role, model, p, k, expt, mean.model, se.model)

rationalDetectComp <- df.unif %>%
  filter(role=="Detector", mor==0) %>%
  mutate(model = "recursive ", 
         k = ks,
         mean.model = val,
         se.model = se) %>%
  select(role, model, p, k, expt, mean.model, se.model)

Expt = 4
moral = lieMoral
idiotLieComp <- data.frame(role = "Liar",
                           model = "uniform+aversion",
                           p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                           k=rep(0:10,3),
                           expt = "expt4",
                           mean.model=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                                  exp.ksay(0.8, rep(bonddepaulo, 11))),
                           se.model = NA)

idiotDetectComp <- data.frame(role = "Detector",
                              model = "uniform+aversion",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              k=rep(0:10,3),
                              expt = "expt4",
                              mean.model=c(detect0.2idiot, 
                                           detect0.5idiot, 
                                           detect0.8idiot),
                              se.model = NA)

moral = 0
idiotLieComp.nomoral <- data.frame(role = "Liar",
                           model = "random opponent",
                           p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                           k=rep(0:10,3),
                           expt = "expt4",
                           mean.model=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                                  exp.ksay(0.8, rep(bonddepaulo, 11))),
                           se.model = NA)

idiotDetectComp.nomoral <- data.frame(role = "Detector",
                              model = "random opponent",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              k=rep(0:10,3),
                              expt = "expt4",
                              mean.model=c(detect0.2idiot.nomoral, 
                                           detect0.5idiot.nomoral, 
                                           detect0.8idiot.nomoral),
                              se.model = NA)


Expt = 5
moral = lieMoral
P.K <- matrix(rep(p.k(0:10, 0.2), each=10+1), nrow=10+1)
lie0.2idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.2idiot_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2idiot)

P.K <- matrix(rep(p.k(0:10, 0.5), each=10+1), nrow=10+1)
lie0.5idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.5idiot_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5idiot)

P.K <- matrix(rep(p.k(0:10, 0.8), each=10+1), nrow=10+1)
lie0.8idiot <- rowSums(P.K*mat.idiotLiar*LIE)/rowSums(P.K*mat.idiotLiar)
detect0.8idiot_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8idiot)

idiotLieComp_expt5 <- data.frame(role = "Liar",
                           model = "uniform+aversion",
                           p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                           k=rep(0:10,3),
                           expt = "expt5",
                           mean.model=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                                  exp.ksay(0.8, rep(bonddepaulo, 11))),
                           se.model = NA)

idiotDetectComp_expt5 <- data.frame(role = "Detector",
                              model = "uniform+aversion",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              k=rep(0:10,3),
                              expt = "expt5",
                              mean.model=c(detect0.2idiot_expt5,
                                           detect0.5idiot_expt5,
                                           detect0.8idiot_expt5),
                              se.model = NA)

moral = 0
detect0.2idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2idiot)
detect0.5idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5idiot)
detect0.8idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8idiot)

idiotLieComp.nomoral_expt5 <- data.frame(role = "Liar",
                           model = "random opponent",
                           p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                           k=rep(0:10,3),
                           expt = "expt5",
                           mean.model=c(exp.ksay(0.2, rep(bonddepaulo, 11)),
                                  exp.ksay(0.5, rep(bonddepaulo, 11)),
                                  exp.ksay(0.8, rep(bonddepaulo, 11))),
                           se.model = NA)

idiotDetectComp.nomoral_expt5 <- data.frame(role = "Detector",
                              model = "random opponent",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              k=rep(0:10,3),
                              expt = "expt5",
                              mean.model=c(detect0.2idiot.nomoral_expt5,
                                           detect0.5idiot.nomoral_expt5,
                                           detect0.8idiot.nomoral_expt5),
                              se.model = NA)

idiotLieComp <- bind_rows(idiotLieComp, idiotLieComp_expt5)
idiotDetectComp <- bind_rows(idiotDetectComp, idiotDetectComp_expt5)
idiotLieComp.nomoral <- bind_rows(idiotLieComp.nomoral, idiotLieComp.nomoral_expt5)
idiotDetectComp.nomoral <- bind_rows(idiotDetectComp.nomoral, idiotDetectComp.nomoral_expt5)

modelComp <- bind_rows(idiotLieComp, idiotDetectComp, idiotLieComp.nomoral, idiotDetectComp.nomoral, modelLieComp, modelDetectComp, rationalLieComp, rationalDetectComp)

humanCompLie <- bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  mutate(k = drawnRed,
         p = probabilityRed) %>%
  group_by(p, k, expt, roleCurrent) %>%
  summarise(mean.human = mean(reportedDrawn), #not sure if this is kosher, but putting lying on same scale as detecting
            sd = sd(reportedDrawn),
            se.human = sd/sqrt(n()),
            n=n()) %>%
  mutate(role = "Liar") %>%
  select(role, p, k, expt, mean.human, se.human)
humanCompDetect <- bs.final %>%
  filter(roleCurrent == "bullshitDetector") %>%
  mutate(k = reportedDrawn,
         p = probabilityRed) %>%
  group_by(p, k, expt, roleCurrent) %>%
  summarise(mean.human = (sum(callBS == "True")+1)/(n()+2),
            se.human = sqrt((mean.human*(1-mean.human)/n())),
            n=n()) %>%
  mutate(role = "Detector") %>%
  select(role, p, k, expt, mean.human, se.human)
humanComp <- bind_rows(humanCompLie, humanCompDetect)


modelVsHuman <- left_join(modelComp, humanComp, by=c("role", "expt", "p", "k")) %>%
  mutate(model = factor(model, levels=c("random opponent", "uniform+aversion", "recursive ", "recursive+aversion")),
         mean.model.logit = ifelse(role=="Detector", prob_to_logit(mean.model), mean.model),
         mean.human.logit = ifelse(role=="Detector", prob_to_logit(mean.human), mean.human))

modelVsHuman %>%
  arrange(p, role, k, expt) %>%
  head(10)

lieComp <- modelVsHuman %>%
  filter(role=="Liar", model!="uniform+aversion", expt=="expt4") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=model, shape=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=3) +
  #geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  scale_x_continuous("Model", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=modelColors) +
  scale_shape_manual(values=pShapes) +
  guides(shape=guide_legend(order=1, title=""),
         fill=guide_legend(order=0, title="", override.aes=list(shape=21))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,0,0,5)),
        axis.line = element_line(size=1, colour=axisLineColour))

detectComp <- modelVsHuman %>%
  filter(role=="Detector", model!="uniform+aversion", expt=="expt4") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=model, shape=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=3) +
  #geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  scale_x_continuous("Model", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=modelColors) +
  scale_shape_manual(values=pShapes) +
  # guides(shape=guide_legend(title="priors"),
  #        fill=guide_legend(override.aes=list(shape=21))) +
  guides(shape=guide_legend(order=1, title=""),
         fill=guide_legend(order=0, title="", override.aes=list(shape=21))) +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,-0.5,0,-2)),
        axis.line = element_line(size=1, colour=axisLineColour))

legendComp <- get_legend(detectComp)
lieCompLabel <- ggdraw() +
  draw_label("Liar", fontface="bold", size=12, y=0.95, x=0.4, hjust=0, angle=270)

detectCompLabel <- ggdraw() + 
  draw_label("Detector", fontface="bold", size=12, y=0.95, x=0.4, hjust=0, angle=270)

bothComp <- plot_grid(lieComp, lieCompLabel, 
                      detectComp + theme(legend.position = "none"), detectCompLabel, ncol=2, rel_widths=c(95,5))

comparison <- ggdraw() +
  draw_plot(bothComp) +
  draw_plot(legendComp, x=-0.08, y=0.45)
  #draw_plot(legendComp, x=-0.18, y=0.35)
comparison
ggsave("img/modelComparison.pdf", comparison, units="cm", height=15, width=8.7)
```

## Model Comparison Facetted by Model
```{r}
lieCompFacet <- modelVsHuman %>%
  filter(role=="Liar", model!="uniform+aversion", expt=="expt4") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  ggtitle("Lying") +
  scale_x_continuous("Model", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff) +
  guides(colour=guide_legend(title="", override.aes=list(size=2.5))) +
  facet_wrap(~model) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,0,0,5)),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompFacet
ggsave("img/lieCompareFacet.png", lieCompFacet, height=4, width=13)

detectCompFacet <- modelVsHuman %>%
  filter(role=="Detector", model!="uniform+aversion", expt=="expt4") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  ggtitle("Detecting") +
  scale_x_continuous("Model", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff, guide="none") +
  facet_wrap(~model) +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,-0.5,0,-2)),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompFacet
ggsave("img/detectCompareFacet.png", detectCompFacet, height=4, width=13)





plotTitleSizeComp = 12
axisTitleSizeComp = 10
axisTextSizeComp = 9

shapeCompare <- c(
  "expt4" = 19,
  "expt5" = 1
)

shapeCompare2 <- c(
  "red payoff" = 19,
  "blue payoff" = 1
)

#Broken down by graphs
lieCompUnif <- modelVsHuman %>%
  filter(role=="Liar", model=="random opponent") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  ggtitle("Random Opponent") +
  scale_x_continuous("Model", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human Sender\nMean Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff) +
  scale_shape_manual(values=shapeCompare) +
  guides(colour=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.text.y = element_text(margin=margin(0,0,0,5)),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompUnif
#ggsave("img/lieCompareUnif.png", lieCompUnif, height=4.1, width=4)

lieCompRecurse <- modelVsHuman %>%
  filter(role=="Liar", model=="recursive ") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  ggtitle("Recursive ToM") +
  scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff) +
  scale_shape_manual(values=shapeCompare) +
  guides(colour=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompRecurse
#ggsave("img/lieCompareRecurse.png", lieCompRecurse, height=4.1, width=4)

lieCompAverse <- modelVsHuman %>%
  filter(role=="Liar", model=="recursive+aversion") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  ggtitle("Recursive ToM + Aversion") +
  scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff) +
  scale_shape_manual(values=shapeCompare) +
  guides(colour=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompAverse
#ggsave("img/lieCompareAverse.png", lieCompAverse, height=4.1, width=4)

detectCompUnif <- modelVsHuman %>%
  filter(role=="Detector", model=="random opponent") %>%
  mutate(p.txt = paste("p =", p),
         expt = factor(ifelse(expt == "expt4", "red payoff", "blue payoff"), levels=c("red payoff", "blue payoff"))) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  scale_x_continuous("Model", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human Receiver\nProportion BS Called", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff, guide="none") +
  scale_shape_manual(values=shapeCompare2, guide="none") +
  guides(shape=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.text.align = 1,
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.text.y = element_text(margin=margin(0,-0.5,0,-2)),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompUnif
#ggsave("img/detectCompareUnif.png", detectCompUnif, height=4.1, width=4)

detectCompRecurse <- modelVsHuman %>%
  filter(role=="Detector", model=="recursive ") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  scale_x_continuous("", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff, guide="none") +
  scale_shape_manual(values=shapeCompare, guide="none") +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompRecurse
#ggsave("img/detectCompareRecurse.png", detectCompRecurse, height=4.1, width=4)

detectCompAverse <- modelVsHuman %>%
  filter(role=="Detector", model=="recursive+aversion") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=2, alpha=0.9) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  scale_x_continuous("", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_colour_manual(values=condColors.diff, guide="none") +
  scale_shape_manual(values=shapeCompare, guide="none") +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompAverse
#ggsave("img/detectCompareAverse.png", detectCompAverse, height=4.1, width=4)


legendComp <- get_legend(lie.results_expt5)
legendComp2 <- get_legend(detectCompUnif)

lieCompPlots <- plot_grid(lieCompUnif,
                          lieCompRecurse,
                          lieCompAverse + theme(legend.position="none"), 
                          nrow=1,
                          rel_widths=c(11.5, 10, 10))

detectCompPlots <- plot_grid(detectCompUnif + theme(legend.position="none"),
                             detectCompRecurse,
                             detectCompAverse, 
                             nrow=1,
                             rel_widths=c(11.5, 10, 10))

liarCompLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.9, x=0.5, hjust=0, angle=270)

lieComprow <- plot_grid(lieCompPlots, liarCompLabel, nrow=1, rel_widths=c(96, 4))

detectorCompLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.99, x=0.5, hjust=0, angle=270)

detectComprow <- plot_grid(detectCompPlots, detectorCompLabel, nrow=1, rel_widths=c(96, 4))

allCompplots <- plot_grid(lieComprow, 
                      detectComprow, 
                      nrow=2,
                      rel_heights=c(0.525, 0.475))

CompwithLegend <- ggdraw() +
  draw_plot(allCompplots) +
  draw_plot(legendComp, x=0.41, y=0.16) +
  draw_plot(legendComp2, x=0.41, y=0.25) +
  draw_label(expression(paste("r"^"2"*" = 0.118")), x=0.15, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.477")), x=0.455, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.965")), x=0.76, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.237")), x=0.15, y=0.455, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.596")), x=0.455, y=0.455, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.730")), x=0.76, y=0.455, size=11)

CompwithLegend
ggsave("img/allComparisons.pdf", 
       CompwithLegend, 
       units="cm", height=11, width=17.8)
```

```{r}
plotTitleSizeComp = 12
axisTitleSizeComp = 10
axisTextSizeComp = 9
pointSize = 2
lineThick = 0.5

sender_points_label = c(
  "expt4" = "Sender gets\npoints for red",
  "expt5" = "Sender gets\npoints for blue"
)

shapeCompare <- c(
  # "expt4" = 19,
  # "expt5" = 21
  "expt4" = 22,
  "expt5" = 24
)

#Broken down by graphs
lieCompUnif <- modelVsHuman %>%
  filter(role=="Liar", model=="random opponent") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, colour="black", stroke=lineThick) +
  ggtitle("Random Opponent") +
  scale_x_continuous("Model", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human Sender\nMean Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red) +
  scale_shape_manual(values=shapeCompare) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.text.y = element_text(margin=margin(0,0,0,5)),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompUnif
#ggsave("img/lieCompareUnif.png", lieCompUnif, height=4.1, width=4)

lieCompRecurse <- modelVsHuman %>%
  filter(role=="Liar", model=="recursive ") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, stroke=lineThick) +
  ggtitle("Recursive ToM") +
  scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red) +
  scale_shape_manual(values=shapeCompare) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompRecurse
#ggsave("img/lieCompareRecurse.png", lieCompRecurse, height=4.1, width=4)

lieCompAverse <- modelVsHuman %>%
  filter(role=="Liar", model=="recursive+aversion") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, stroke=lineThick) +
  ggtitle("Recursive ToM + Aversion") +
  scale_x_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red) +
  scale_shape_manual(values=shapeCompare) +
  theme_minimal() +
  theme(legend.position="none",
        plot.title = element_text(size=plotTitleSizeComp, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
lieCompAverse
#ggsave("img/lieCompareAverse.png", lieCompAverse, height=4.1, width=4)

detectCompUnif <- modelVsHuman %>%
  filter(role=="Detector", model=="random opponent") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, stroke=lineThick) +
  scale_x_continuous("Model", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("Human Receiver\nProportion BS Called", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red, guide="none") +
  scale_shape_manual(values=shapeCompare, labels=sender_points_label) +
  guides(shape=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        #legend.text.align = 1,
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.text.y = element_text(margin=margin(0,-0.5,0,-2)),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompUnif
#ggsave("img/detectCompareUnif.png", detectCompUnif, height=4.1, width=4)

detectCompRecurse <- modelVsHuman %>%
  filter(role=="Detector", model=="recursive ") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, stroke=lineThick) +
  scale_x_continuous("", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red, guide="none") +
  scale_shape_manual(values=shapeCompare, guide="none") +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompRecurse
#ggsave("img/detectCompareRecurse.png", detectCompRecurse, height=4.1, width=4)

detectCompAverse <- modelVsHuman %>%
  filter(role=="Detector", model=="recursive+aversion") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, fill=p.txt, shape=expt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02, size=lineThick) +
  geom_point(size=pointSize, alpha=0.9, stroke=lineThick) +
  scale_x_continuous("", limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0,0.025,0)) +
  scale_fill_manual(values=my_red, labels=p_label) +
  scale_shape_manual(values=shapeCompare, guide="none") +
  guides(fill=guide_legend(title="Base Rate", override.aes=list(size=2, shape=21))) +
  theme_minimal() +
  theme(legend.key.size = unit(0.34, 'cm'),
        legend.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.box = "horizontal",
        plot.title = element_text(size=plotTitleSize, face = "bold"),
        plot.margin = marginDim,
        axis.title = element_text(size=axisTitleSizeComp),
        axis.text = element_text(size=axisTextSizeComp),
        axis.line = element_line(size=1, colour=axisLineColour))
detectCompAverse
#ggsave("img/detectCompareAverse.png", detectCompAverse, height=4.1, width=4)


legendComp <- get_legend(detectCompAverse)
legendComp2 <- get_legend(detectCompUnif)

lieCompPlots <- plot_grid(lieCompUnif,
                          lieCompRecurse,
                          lieCompAverse + theme(legend.position="none"), 
                          nrow=1,
                          rel_widths=c(11.5, 10, 10))

detectCompPlots <- plot_grid(detectCompUnif + theme(legend.position="none"),
                             detectCompRecurse,
                             detectCompAverse + theme(legend.position="none"), 
                             nrow=1,
                             rel_widths=c(11.5, 10, 10))

liarCompLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.9, x=0.5, hjust=0, angle=270)

lieComprow <- plot_grid(lieCompPlots, liarCompLabel, nrow=1, rel_widths=c(96, 4))

detectorCompLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.99, x=0.5, hjust=0, angle=270)

detectComprow <- plot_grid(detectCompPlots, detectorCompLabel, nrow=1, rel_widths=c(96, 4))

allCompplots <- plot_grid(lieComprow, 
                      detectComprow, 
                      nrow=2,
                      rel_heights=c(0.525, 0.475))

CompwithLegend <- ggdraw() +
  draw_plot(allCompplots) +
  draw_plot(legendComp, x=0.43, y=0.25) +
  draw_plot(legendComp2, x=0.41, y=0.135) +
  draw_label(expression(paste("r"^"2"*" = 0.118")), x=0.15, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.477")), x=0.455, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.965")), x=0.76, y=0.93, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.237")), x=0.15, y=0.455, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.596")), x=0.455, y=0.455, size=11) +
  draw_label(expression(paste("r"^"2"*" = 0.730")), x=0.76, y=0.455, size=11)

CompwithLegend
ggsave("img/allComparisons.pdf", 
       CompwithLegend, 
       units="cm", height=11, width=17.8)
```

## Compute R^2

```{r}
# by role and model and expt
modelVsHuman %>%
  group_by(role, model, expt) %>%
  summarise(r = cor(mean.model, mean.human),
            r.squared = r^2,
            p = cor.test(mean.model, mean.human)$p.value)

# by role and model
modelVsHuman %>%
  group_by(role, model) %>%
  summarise(r = cor(mean.model, mean.human),
            r.squared = r^2,
            p = cor.test(mean.model, mean.human)$p.value)

# collapsing over role
modelVsHuman %>%
  group_by(model) %>%
  summarise(r = cor(mean.model, mean.human),
            r.squared = r^2,
            p = cor.test(mean.model, mean.human)$p.value)
```

# Model Comparison with Panels for Each Model
```{r}
lieComp_facet <- modelVsHuman %>%
  filter(model != "uniform+moral", expt == "expt4", role == "Liar") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=1) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.1) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.1) +
  scale_x_continuous("Model", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Human", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  facet_grid(model~.) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,0,0,5))) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, colour=axisLineColour, size=2) +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, colour=axisLineColour, size=2)
ggsave("img/lieComparison_facet.png", lieComp_facet, height=7.75, width=3.5)


detectComp_facet <- modelVsHuman %>%
  filter(model != "uniform+moral", expt == "expt4", role == "Detector") %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt)) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  geom_point(size=1) +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  scale_x_continuous("Model", limits=c(0,1), expand=c(0,0)) +
  scale_y_continuous("Human", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  # guides(colour=guide_legend(override.aes=list(shape=21))) +
  guides(colour=guide_legend(title="")) +
  facet_grid(model~.) +
  theme_minimal() +
  theme(legend.position = "none",
        #legend.key.size = unit(0.34, 'cm'),
        #legend.text = element_text(size=7),
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=10),
        axis.text = element_text(size=9),
        axis.text.y = element_text(margin=margin(0,-0.5,0,-2))) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf, colour=axisLineColour, size=2) +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf, colour=axisLineColour, size=2)
ggsave("img/detectComparison_facet.png", detectComp_facet, height=7.75, width=3.5)
```

# Model Predictions Feeding in Human Results

## Lie Detector Behavior from Lying Results

```{r}
moral = 20
Expt = 4

# "template" for tidyr complete() function
template <- data.frame(expt = NA,
                       probabilityRed = rep(0,11),
                       drawnRed = rep(0,11),
                       reportedDrawn = 0:10,
                       n = rep(0,11))

liePropsDF <- bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  group_by(expt, probabilityRed, drawnRed, reportedDrawn) %>%
  summarise(n=n()) 

liePropsDF <- bind_rows(template,liePropsDF) %>%
  complete(expt, probabilityRed, drawnRed, reportedDrawn, fill=list(n=0)) %>%
  filter(!is.na(expt), probabilityRed != 0) %>%
  group_by(expt, probabilityRed, drawnRed) %>%
  mutate(total = sum(n),
         proportion = n / total) %>%
  filter(expt == "expt4")

LIE <- 1-diag(numMarbles+1)
# equivalent to output of p.L_ksay.k.r
df0.2 <- liePropsDF %>%
  filter(probabilityRed == 0.2)
mat0.2 <- matrix(df0.2$proportion, nrow=11)
# output p_t.ksay.r
P.K <- matrix(rep(p.k(0:numMarbles, 0.2), each=numMarbles+1), nrow=numMarbles+1)
lie0.2 <- rowSums(P.K*mat0.2*LIE)/rowSums(P.K*mat0.2)
# output p.D_bs.ksay.r
detect0.2 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2)

df0.5 <- liePropsDF %>%
  filter(probabilityRed == 0.5)
mat0.5 <- matrix(df0.5$proportion, nrow=11)
P.K <- matrix(rep(p.k(0:10, 0.5), each=10+1), nrow=10+1)
lie0.5 <- rowSums(P.K*mat0.5*LIE)/rowSums(P.K*mat0.5)
detect0.5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5)

df0.8 <- liePropsDF %>%
  filter(probabilityRed == 0.8)
mat0.8 <- matrix(df0.8$proportion, nrow=11)
P.K <- matrix(rep(p.k(0:10, 0.8), each=10+1), nrow=10+1)
lie0.8 <- rowSums(P.K*mat0.8*LIE)/rowSums(P.K*mat0.8)
detect0.8 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8)

detect.respondToHumanData <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           ksay=rep(0:10,3),
           bs=c(detect0.2, detect0.5, detect0.8)) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=ksay, y=bs, colour=probabilityRed.txt)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff)+
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.respondToHumanData 
ggsave("img/modelRespondToData_detect.png", detect.respondToHumanData, height=8, width=7.5)
```

## Liar Behavior from Lie Detector Results

```{r}
bsPropsDF <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt4") %>%
  group_by(probabilityRed, reportedDrawn) %>%
  summarise(count = sum(callBS == "True"),
            total = n(),
            propBS = count/total) %>%
  select(probabilityRed, reportedDrawn, propBS) %>%
  mutate(proptruth = p_t.ksay.r(probabilityRed, propBS),
         lie = exp.ksay(probabilityRed, propBS))
bsProps0.2 <- bsPropsDF %>%
  filter(probabilityRed == 0.2)
propksay0.2 <- colSums(KSAY*p.L_ksay.k.r(0.2, bsProps0.2$propBS))
proptruth <- p_t.ksay.r(0.2, bsProps0.2$propBS)

lie.respondToHumanData <- bsPropsDF %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  ggplot(aes(x=reportedDrawn, y=lie, colour=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_line(size=lineSize, alpha=alphaLine) +
  ggtitle("Input: Human") +
  scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.respondToHumanData
ggsave("img/modelRespondToData_lie.png", lie.respondToHumanData, height=8, width=7.5)
```



## Uniform Liar + Detector

```{r}
lie.idiot <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           k=rep(0:10,3),
           ksay=sum(0:10 * 1/11)) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=k, y=ksay, colour=probabilityRed.txt)) +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=2, size=ablineSize) +
  geom_line(size=lineSize, alpha=alphaLine) +
  ggtitle("Uniform Opponent") +
  scale_x_continuous("True Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.y = element_text(margin=margin(0,0,0,25.5)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
lie.idiot
ggsave("img/modelIdiot_lie.png", lie.idiot, height=8, width=7.5)     

detect.idiot <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           ksay=rep(0:10,3),
           bs=avgPropBS) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=ksay, y=bs, colour=probabilityRed.txt)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("Reported Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff)+
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.idiot
ggsave("img/modelIdiot_detect.png", detect.idiot, height=8, width=7.5)     
```


```{r}
# with just morality model
modelLieComp <- df.unif %>%
  filter(role=="Liar", mor==lieMoral) %>%
  mutate(model = "moral", 
         k = ks,
         mean.model = val/10,
         se.model = se/10) %>%
  select(role, model, p, k , mean.model, se.model)

modelDetectComp <- df.unif %>%
  filter(role=="Detector", mor==detectMoral) %>%
  mutate(model = "moral", 
         k = ks,
         mean.model = val,
         se.model = se) %>%
  select(role, model, p, k , mean.model, se.model)

modelComp <- bind_rows(modelLieComp, modelDetectComp)

humanCompLie <- bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  mutate(k = drawnRed,
         p = probabilityRed) %>%
  group_by(p, k, roleCurrent) %>%
  summarise(mean.human = mean(reportedDrawn)/10, #not sure if this is kosher, but putting lying on same scale as detecting
            sd = sd(reportedDrawn)/10,
            se.human = sd/sqrt(n()),
            n=n()) %>%
  mutate(role = "Liar") %>%
  select(role, p, k , mean.human, se.human)
humanCompDetect <- bs.final %>%
  filter(roleCurrent == "bullshitDetector") %>%
  mutate(k = reportedDrawn,
         p = probabilityRed) %>%
  group_by(p, k, roleCurrent) %>%
  summarise(mean.human = (sum(callBS == "True")+1)/(n()+2),
            se.human = sqrt((mean.human*(1-mean.human)/n())),
            n=n()) %>%
  mutate(role = "Detector") %>%
  select(role, p, k , mean.human, se.human)
humanComp <- bind_rows(humanCompLie, humanCompDetect)

modelVsHuman <- left_join(modelComp, humanComp, by=c("role", "p", "k"))

comp <- modelVsHuman %>%
  mutate(p.txt = paste("p =", p)) %>%
  ggplot(aes(x=mean.model, y=mean.human, colour=p.txt, shape=role)) +
  geom_point() +
  geom_errorbar(aes(ymin=mean.human-se.human, ymax=mean.human+se.human), width=.02) +
  #geom_errorbarh(aes(xmin=mean.model-se.model, xmax=mean.model+se.model), height=.02) +
  geom_abline(intercept = 0, slope = 1, linetype=2) +
  scale_x_continuous("Model", limits=c(0,1)) +
  scale_y_continuous("Human", limits=c(0,1)) +
  scale_colour_manual(values = condColors.diff) +
  guides(colour=guide_legend(title="")) +
  facet_grid(role~.) +
  theme_minimal() +
  theme(axis.title = element_text(size=18),
        axis.text = element_text(size=18))
comp
```


```{r}
df.unif %>%
  filter(role=="Liar", mor==lieMoral, expt=="expt5") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_abline(size=ablineSize, intercept = 0, slope = 1, colour="darkgray", linetype=2) +
  geom_line(size=lineSize, alpha=alphaLine) +
  ggtitle("Recursive") +
  scale_x_continuous("", labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",6), limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
ggsave("img/modelRecurse_lie_expt5.png", height=2.5, width=3)

df.unif %>%
  filter(role=="Detector", mor==detectMoral, expt=="expt5") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
ggsave("img/modelRecurse_detect_expt5.png", height=2.5, width=3)
```

```{r}
df.unif %>%
  filter(role=="Detector", mor==detectMoral, expt=="expt4") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
ggsave("img/modelRecurse_detect_expt4.png", height=2.5, width=3)

```

```{r}
df.unif %>%
  filter(role=="Liar", mor==0, expt=="expt4", p==0.5) %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val)) +
  geom_line(colour="purple3", size=5) +
  geom_abline(size=4, intercept = 0, slope = 1, colour="darkgray", linetype=2, lwd=1) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10)) +
  scale_y_continuous("", limits=c(0,10), breaks=c(0,2,4,6,8,10)) +
  theme_minimal() +
  theme(axis.text = element_text(size=24))
ggsave("img/modelRecurse_lie_expt1.png", height=5, width=7)

df.unif %>%
  filter(role=="Detector", mor==0, expt=="expt4", p==0.5) %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val)) +
  geom_line(colour="purple3", size=5) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10)) +
  scale_y_continuous("", limits=c(0,1)) +
  theme_minimal() +
  theme(axis.text = element_text(size=24))
ggsave("img/modelRecurse_detect_expt1.png", height=5, width=7)
```


## MLE Analysis


```{r warning=FALSE}
set.seed(100)
logitToProb <- function(logit){
  exp(logit) / (1+exp(logit))
}

probToLogit <- function(prob){
  log(prob / (1 - prob))
}

quadratic <- function(x, a, b, c){
  a*(x-b)^2+c
}

logisticModel <- function(x, a, b, c){
  logitToProb(pmin(10, pmax(-10, quadratic(x, a, b, c))))
}

lapsePlusLogistic <- function(x, a, b, c, alph){
  alph2 = logitToProb(alph)
  a = exp(a)
  alph2/2 + (1-alph2)*logisticModel(x, a, b, c)
}

loglik <- function(x, y, a, b, c, alph){
  sum(
    dbinom(y, 1, lapsePlusLogistic(x, a, b, c, alph), log=T)
  )
}

brutefit <- function(tmp){
  nLL <- function(a, b, c, alph){
    -loglik(tmp$reportedDrawn, tmp$callBS, a, b, c, alph)+
      (a-1)^2+
      (b-5)^2+
      c^2+
      (alph+2)^2
  }

  iter = 0
  fits = NULL
  fit = NULL
  while(is.null(fits)){
    try(fit <- summary(mle(nLL,
                           start=list(a=rnorm(1, 0, 3),
                                      b=rnorm(1, 0, 3),
                                      c=rnorm(1, 0, 3),
                                      alph=rnorm(1, -2, 3)), method = 'BFGS'), TRUE))
    iter = iter+1

    if(! is.null(fit)){
      fits <- c(tmp$probabilityRed[1], -0.5*fit@m2logL, length(tmp$reportedDrawn), fit@coef[,"Estimate"], fit@coef[,"Std. Error"])
    } else {
      if(iter>100){
        fits <- c(tmp$probabilityRed[1], -9999, 0, 0, 0, 0, 0, 0, 0, 0, 0)
      }
    }
  }
  names(fits) <- c("probabilityRed", "logL", "n", "est.a", "est.b", "est.c", "est.alph", "se.a", "se.b", "se.c", "se.alph")
  return(fits)
}

ps = c(-0.5, 0.5, -0.5, 0.5, -0.5, 0.5, -5, -0.5)
names(ps) <- c("min_a", "max_a", "min_b", "max_b", "min_c", "max_c", "min_alph", "max_alph")

humanDetect_expt4 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt4") %>%
  mutate(callBS = ifelse(callBS == "False", FALSE, TRUE),
         avgRed = probabilityRed * 10,
         probabilityRed.f = relevel(as.factor(probabilityRed), ref="0.5"))
quadr.fits_expt4 <- data.frame(do.call(rbind, by(humanDetect_expt4, humanDetect_expt4$probabilityRed.f, brutefit)))
print(paste("Failed quadratic fits:", sum(quadr.fits_expt4$logL==-9999)))


quadr.est_expt4 <- quadr.fits_expt4 %>%
  select(1:7) %>%
  gather("variable", "estimate", 4:7) %>%
  mutate(variable = gsub("est.", "", variable))
quadr.se_expt4 <- quadr.fits_expt4 %>%
  select(-c(4:7)) %>%
  gather("variable", "std.err", 4:7) %>%
  mutate(variable = gsub("se.", "", variable))
quadr.summ_expt4 <- left_join(quadr.est_expt4, quadr.se_expt4, by=c("probabilityRed","logL","n","variable"))
quadr.summ_expt4 %>%
  mutate(z.value = estimate/std.err,
         p.value = ifelse(pnorm(-abs(z.value)) > .000001, pnorm(-abs(z.value)), "<.000001")) %>%
  arrange(probabilityRed, variable)

# y = a(x-b)^2 + c
b_0.2_expt4 <- quadr.summ_expt4 %>%
  filter(variable == "b", probabilityRed == 0.2)
b_0.5_expt4 <- quadr.summ_expt4 %>%
  filter(variable == "b", probabilityRed == 0.5)
b_0.8_expt4 <- quadr.summ_expt4 %>%
  filter(variable == "b", probabilityRed == 0.8)

# one sided 2 sample t test with pooled variance
wald.z.test <- function(m1, sd1, m2, sd2){
  z <- (m1 - m2) / sqrt(sd1^2 + sd2^2)
  p <- pnorm(abs(z), lower.tail=F)
  return(data.frame(m1, sd1, m2, sd2, z, p))
}

wald.z.test(b_0.5_expt4$estimate, b_0.5_expt4$std.err, b_0.2_expt4$estimate, b_0.2_expt4$std.err)
wald.z.test(b_0.5_expt4$estimate, b_0.5_expt4$std.err, b_0.8_expt4$estimate, b_0.8_expt4$std.err)

quadr.plot_expt4 <- data.frame(x=rep(0:10,3), 
           p=as.factor(c(rep(0.2,11), rep(0.5,11), rep(0.8,11))),
           a=c(rep(quadr.fits_expt4$est.a[quadr.fits_expt4$probabilityRed==0.2],11),
               rep(quadr.fits_expt4$est.a[quadr.fits_expt4$probabilityRed==0.5],11),
               rep(quadr.fits_expt4$est.a[quadr.fits_expt4$probabilityRed==0.8],11)),
           b=c(rep(quadr.fits_expt4$est.b[quadr.fits_expt4$probabilityRed==0.2],11),
               rep(quadr.fits_expt4$est.b[quadr.fits_expt4$probabilityRed==0.5],11),
               rep(quadr.fits_expt4$est.b[quadr.fits_expt4$probabilityRed==0.8],11)),
           c=c(rep(quadr.fits_expt4$est.c[quadr.fits_expt4$probabilityRed==0.2],11),
               rep(quadr.fits_expt4$est.c[quadr.fits_expt4$probabilityRed==0.5],11),
               rep(quadr.fits_expt4$est.c[quadr.fits_expt4$probabilityRed==0.8],11)),
           alph=c(rep(quadr.fits_expt4$est.alph[quadr.fits_expt4$probabilityRed==0.2],11),
               rep(quadr.fits_expt4$est.alph[quadr.fits_expt4$probabilityRed==0.5],11),
               rep(quadr.fits_expt4$est.alph[quadr.fits_expt4$probabilityRed==0.8],11))) %>%
  mutate(prob=lapsePlusLogistic(x, a, b, c, alph))
ggplot(quadr.plot_expt4, aes(x=x, y=prob, colour=p)) +
  geom_line() +
  scale_y_continuous(limits=c(0,1))
ggsave("img/quadraticFit_expt4.png")

exptDetect_expt4 <- bs.final %>%
  filter(expt=="expt4", roleCurrent == "bullshitDetector") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  mutate(fit="experiment")
quadr.plot2_expt4 <- data.frame(probabilityRed.txt = paste("p =", quadr.plot_expt4$p),
                          reportedDrawn = quadr.plot_expt4$x,
                          prop = quadr.plot_expt4$prob,
                          se = NA,
                          n = NA,
                          fit = "model")
quadr.plot_full_expt4 <- bind_rows(exptDetect_expt4, quadr.plot2_expt4)
ggplot(data=quadr.plot_full_expt4, aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, linetype=fit)) +
  geom_point(data=filter(quadr.plot_full_expt4, fit=="experiment")) +
  geom_line() +
  geom_errorbar(data=filter(quadr.plot_full_expt4, fit=="experiment"), aes(x=reportedDrawn, colour=probabilityRed.txt, min=prop-se, max=prop+se), width=.3) +
  scale_x_continuous("Reported Marbles Drawn", limits=c(-0.2,10.2)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1)) +
  guides(colour=guide_legend(title="")) +
  theme_minimal()
ggsave("img/fit_expt_model_expt4.png")
```

```{r}
humanDetect_expt5 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt5") %>%
  mutate(callBS = ifelse(callBS == "False", FALSE, TRUE),
         avgRed = probabilityRed * 10,
         probabilityRed.f = relevel(as.factor(probabilityRed), ref="0.5"))
quadr.fits_expt5 <- data.frame(do.call(rbind, by(humanDetect_expt5, humanDetect_expt5$probabilityRed.f, brutefit)))
print(paste("Failed quadratic fits:", sum(quadr.fits_expt5$logL==-9999)))


quadr.est_expt5 <- quadr.fits_expt5 %>%
  select(1:7) %>%
  gather("variable", "estimate", 4:7) %>%
  mutate(variable = gsub("est.", "", variable))
quadr.se_expt5 <- quadr.fits_expt5 %>%
  select(-c(4:7)) %>%
  gather("variable", "std.err", 4:7) %>%
  mutate(variable = gsub("se.", "", variable))
quadr.summ_expt5 <- left_join(quadr.est_expt5, quadr.se_expt5, by=c("probabilityRed","logL","n","variable"))
quadr.summ_expt5 %>%
  mutate(z.value = estimate/std.err,
         p.value = ifelse(pnorm(-abs(z.value)) > .000001, pnorm(-abs(z.value)), "<.000001")) %>%
  arrange(probabilityRed, variable)

# y = a(x-b)^2 + c
b_0.2_expt5 <- quadr.summ_expt5 %>%
  filter(variable == "b", probabilityRed == 0.2)
b_0.5_expt5 <- quadr.summ_expt5 %>%
  filter(variable == "b", probabilityRed == 0.5)
b_0.8_expt5 <- quadr.summ_expt5 %>%
  filter(variable == "b", probabilityRed == 0.8)

wald.z.test(b_0.5_expt5$estimate, b_0.5_expt5$std.err, b_0.2_expt5$estimate, b_0.2_expt5$std.err)
wald.z.test(b_0.5_expt5$estimate, b_0.5_expt5$std.err, b_0.8_expt5$estimate, b_0.8_expt5$std.err)

quadr.plot_expt5 <- data.frame(x=rep(0:10,3), 
           p=as.factor(c(rep(0.2,11), rep(0.5,11), rep(0.8,11))),
           a=c(rep(quadr.fits_expt5$est.a[quadr.fits_expt5$probabilityRed==0.2],11),
               rep(quadr.fits_expt5$est.a[quadr.fits_expt5$probabilityRed==0.5],11),
               rep(quadr.fits_expt5$est.a[quadr.fits_expt5$probabilityRed==0.8],11)),
           b=c(rep(quadr.fits_expt5$est.b[quadr.fits_expt5$probabilityRed==0.2],11),
               rep(quadr.fits_expt5$est.b[quadr.fits_expt5$probabilityRed==0.5],11),
               rep(quadr.fits_expt5$est.b[quadr.fits_expt5$probabilityRed==0.8],11)),
           c=c(rep(quadr.fits_expt5$est.c[quadr.fits_expt5$probabilityRed==0.2],11),
               rep(quadr.fits_expt5$est.c[quadr.fits_expt5$probabilityRed==0.5],11),
               rep(quadr.fits_expt5$est.c[quadr.fits_expt5$probabilityRed==0.8],11)),
           alph=c(rep(quadr.fits_expt5$est.alph[quadr.fits_expt5$probabilityRed==0.2],11),
               rep(quadr.fits_expt5$est.alph[quadr.fits_expt5$probabilityRed==0.5],11),
               rep(quadr.fits_expt5$est.alph[quadr.fits_expt5$probabilityRed==0.8],11))) %>%
  mutate(prob=lapsePlusLogistic(x, a, b, c, alph))
ggplot(quadr.plot_expt5, aes(x=x, y=prob, colour=p)) +
  geom_line() +
  scale_y_continuous(limits=c(0,1))
ggsave("img/quadraticFit_expt5.png")

exptDetect_expt5 <- bs.final %>%
  filter(expt=="expt5", roleCurrent == "bullshitDetector") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  mutate(fit="experiment")
quadr.plot2_expt5 <- data.frame(probabilityRed.txt = paste("p =", quadr.plot_expt5$p),
                          reportedDrawn = quadr.plot_expt5$x,
                          prop = quadr.plot_expt5$prob,
                          se = NA,
                          n = NA,
                          fit = "model")
quadr.plot_full_expt5 <- bind_rows(exptDetect_expt5, quadr.plot2_expt5)
ggplot(data=quadr.plot_full_expt5, aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, linetype=fit)) +
  geom_point(data=filter(quadr.plot_full_expt5, fit=="experiment")) +
  geom_line() +
  geom_errorbar(data=filter(quadr.plot_full_expt5, fit=="experiment"), aes(x=reportedDrawn, colour=probabilityRed.txt, min=prop-se, max=prop+se), width=.3) +
  scale_x_continuous("Reported Marbles Drawn", limits=c(-0.2,10.2)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1)) +
  guides(colour=guide_legend(title="")) +
  theme_minimal()
ggsave("img/fit_expt_model_expt5.png")
```

```{r}
meancomb <- function(mus, sds){
  sum(mus/sds^2)/sum(1/sds^2)
}

## compare utility conditions
chisqu_util <- function(bs, sds){
  b_0.2 = meancomb(c(bs[1],bs[4]), c(sds[1],sds[4]))
  b_0.5 = meancomb(c(bs[2],bs[5]), c(sds[2],sds[5]))
  b_0.8 = meancomb(c(bs[3],bs[6]), c(sds[3],sds[6]))
  sum(((c(bs[1],bs[4]) - b_0.2)/c(sds[1],sds[4]))^2) + sum(((c(bs[2],bs[5]) - b_0.5)/c(sds[2],sds[5]))^2) + sum(((c(bs[3],bs[6]) - b_0.8)/c(sds[3],sds[6]))^2)
}

detectMLE.pred <- data.frame(p=as.factor(rep(c(0.2,0.5,0.8),2)),
                          expt=as.factor(c(rep("expt4",3), rep("expt5",3))),
                          b=c(filter(quadr.summ_expt4, probabilityRed==0.2 & variable=="b")$estimate,
                               filter(quadr.summ_expt4, probabilityRed==0.5 & variable=="b")$estimate,
                               filter(quadr.summ_expt4, probabilityRed==0.8 & variable=="b")$estimate,
                               filter(quadr.summ_expt5, probabilityRed==0.2 & variable=="b")$estimate,
                               filter(quadr.summ_expt5, probabilityRed==0.5 & variable=="b")$estimate,
                               filter(quadr.summ_expt5, probabilityRed==0.8 & variable=="b")$estimate),
                          b.se=c(filter(quadr.summ_expt4, probabilityRed==0.2 & variable=="b")$std.err,
                               filter(quadr.summ_expt4, probabilityRed==0.5 & variable=="b")$std.err,
                               filter(quadr.summ_expt4, probabilityRed==0.8 & variable=="b")$std.err,
                               filter(quadr.summ_expt5, probabilityRed==0.2 & variable=="b")$std.err,
                               filter(quadr.summ_expt5, probabilityRed==0.5 & variable=="b")$std.err,
                               filter(quadr.summ_expt5, probabilityRed==0.8 & variable=="b")$std.err))

detectMLE.pred %>%
  mutate(CIlower = b - 1.96*b.se,
         CIupper = b + 1.96*b.se)

matr_b.se <- matrix(detectMLE.pred$b.se, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))
matr_b.mean <- matrix(detectMLE.pred$b, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))


(truechi <- chisqu_util(as.vector(matr_b.mean), as.vector(matr_b.se)))


(pchi <- pchisq(truechi, df=4, lower.tail=FALSE))

# do thissss
## simulate chi-square
n = 10000
simChiSq <- data.frame(n=numeric(),
                       i=numeric(),
                       j=numeric(),
                       b=numeric(),
                       chisq=numeric())
for(i in 1:n){
  means = rnorm(6,0,as.vector(matr_b.se))
  chi = chisqu_util(means, as.vector(matr_b.se))
  newdf = data.frame(n=i,
                     i=rep(1:3, 2),
                     j=rep(1:2, each=3),
                     mu = means,
                     chisq = chi)
  simChiSq = bind_rows(simChiSq, newdf)
}

orderedSim <- simChiSq %>%
  select(n, chisq) %>%
  group_by(n) %>%
  unique() %>%
  arrange(chisq)

ggplot(orderedSim, aes(x=chisq)) +
  geom_density() +
  geom_vline(xintercept=orderedSim$chisq[9500], colour="red") +
  ggtitle("Simulated chi-square (df=4) distribution")
```

```{r}
detectParamPlot <- detectMLE.pred %>%
  mutate(p = as.numeric(as.character(p)),
         payoff = ifelse(expt=="expt4", "red payoff", "blue payoff")) %>%
  bind_rows(data.frame(p=c(0.2,0.5,0.8), 
                       payoff="null", 
                       b=c(2, 5, 8))) %>%
  mutate(p.fact=paste("p =",p),
         payoff=fct_relevel(payoff, c("red payoff", "blue payoff", "null")),
         compare=ifelse(payoff=="null", TRUE, FALSE)) %>%
  ggplot(aes(x=p, y=b, pch=payoff)) +
  geom_line(aes(lty=compare)) +
  geom_errorbar(aes(x=p, y=b, ymin=b-2*b.se, ymax=b+2*b.se), width=0.05) +
  geom_point(aes(fill=p.fact), size=2) +
  scale_x_continuous("Base Rate Probability", limits=c(0,1), breaks=seq(0,1,0.1), expand=c(0,0)) +
  scale_y_continuous("Reported Marbles", limits=c(0,10), breaks=c(2,5,8), expand=c(0,0)) +
  scale_shape_manual(values=c(22,24,21)) +
  scale_linetype_discrete(guide="none") +
  scale_fill_manual(values = condColors.diff, guide="none") +
  guides(shape=guide_legend(title="")) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        #axis.title.y = element_text(angle=0, vjust=0.5),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

legend_param <- get_legend(detectParamPlot)

# pair results with model parameter

detectplots_results <- plot_grid( 
  detect.results_expt4 + ggtitle("Red Payoff") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
  detect.results_expt5 + ggtitle("Blue Payoff") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         nrow=1,
                         rel_widths=c(11.32, 10))

detectplots_results_full <- plot_grid(detectplots_results,
                                      detectParamPlot + ggtitle("") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        legend.position="none"),
        nrow=2,
                         rel_heights=c(1,1.5))

detectorLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.94, x=0.5, hjust=0, angle=270)

detectrow_results <- plot_grid(detectplots_results_full, detectorLabel, nrow=1, rel_widths=c(94, 6))

withLegend_results <- ggdraw() +
  draw_plot(detectrow_results) +
  draw_plot(legend, x=0.38, y=0.02) +
  draw_plot(legend_param, x=0.35, y=-0.3) +
  draw_label("a)", size=10, x=0.1, y=0.98) +
  draw_label("b)", size=10, x=0.1, y=0.58)
  
ggsave("img/detectResultsParam.pdf", 
       withLegend_results, 
       units="cm", height=10, width=8.7)

```


```{r}
detect.results_expt5 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt5") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_ribbon(aes(ymin=prop-se, ymax=prop+se), alpha=0.3) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_point(pch=21, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
  scale_y_continuous("Receiver Prop. BS Called", limits=c(0,1), expand=c(0,0)) + 
  scale_colour_manual(values = condColors.diff) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5)), colour="none") +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        legend.position = "top",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

#HERE
detectParamPlot <- detectMLE.pred %>%
  mutate(p = as.numeric(as.character(p)),
         payoff = ifelse(expt=="expt4", "red payoff", "blue payoff")) %>%
  bind_rows(data.frame(p=c(0.2,0.5,0.8), 
                       payoff="null", 
                       b=c(2, 5, 8))) %>%
  mutate(p.fact=paste("p =",p),
         payoff=fct_relevel(payoff, c("red payoff", "null", "blue payoff")),
         compare=ifelse(payoff=="null", TRUE, FALSE)) %>%
  ggplot(aes(x=b, y=p, pch=payoff)) +
  geom_line(aes(lty=compare)) +
  geom_errorbarh(aes(x=b, y=p, xmin=b-2*b.se, xmax=b+2*b.se), height=0.06) +
  geom_point(aes(fill=p.fact), size=2) +
  scale_y_continuous("Base Rate Probability", limits=c(0,1), breaks=c(0.2,0.5,0.8), expand=c(0,0)) +
  scale_x_continuous("Expected Least BS Called Reported Marbles", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
  scale_shape_manual(values=c(22,21,24)) +
  scale_linetype_discrete(guide="none") +
  scale_fill_manual(values = condColors.diff, guide="none") +
  guides(shape=guide_legend(title="")) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        legend.position="top",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        #axis.title.y = element_text(angle=0, vjust=0.5),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,4.5,0,2)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

legend_param <- get_legend(detectParamPlot)
legend_horiz <- get_legend(detect.results_expt5)

# pair results with model parameter

detectplots_results_full <- plot_grid( 
  detect.results_expt4 + ggtitle("Red Payoff") + 
    scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
    theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold")),
  ggdraw(),
  detect.results_expt5 + ggtitle("Blue Payoff") + 
    theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold"),
        legend.position="none"), 
  ggdraw(),
  detectParamPlot + ggtitle("Trough Parameter") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold"),
        legend.position="none"),
  nrow=5,
  rel_heights=c(1, 0.01, 1, 0.05, 1.5))

detectorLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.94, x=0.5, hjust=0, angle=270)

detectrow_results <- plot_grid(detectplots_results_full, detectorLabel, nrow=1, rel_widths=c(94, 6))

withLegend_results <- ggdraw() +
  draw_plot(detectrow_results) +
  draw_plot(legend_horiz, x=0.04, y=0.45) +
  draw_plot(legend_param, x=0.04, y=-0.12) +
  draw_label("a)", size=10, x=0.1, y=0.99) +
  draw_label("b)", size=10, x=0.1, y=0.705) +
  draw_label("c)", size=10, x=0.1, y=0.41)
  
ggsave("img/detectResultsParam_horiz.pdf", 
       withLegend_results, 
       units="cm", height=18, width=8.7)

```

```{r}
detect.results_expt4 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt4") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, expt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_ribbon(aes(ymin=prop-se, ymax=prop+se), alpha=0.3, colour="gray32", size=0.25) +
  geom_point(shape=22, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  #scale_x_continuous("", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  #scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Receiver Prop. BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values = my_red, guide="none") +
  scale_fill_manual(values = my_red) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

detect.results_expt5 <- bs.final %>%
  filter(roleCurrent == "bullshitDetector", expt=="expt5") %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, reportedDrawn) %>%
  summarise(prop = (sum(callBS == "True")+1)/(n()+2),
            se = sqrt((prop*(1-prop)/n())),
            n = n()) %>%
  filter(n > 3) %>%
  ggplot(aes(x=reportedDrawn, y=prop, colour=probabilityRed.txt, fill=probabilityRed.txt)) +
  geom_line(size=0.8, alpha=alphaLine) +
  geom_ribbon(aes(ymin=prop-se, ymax=prop+se), alpha=0.3, colour="gray32", size=0.25) +
  geom_point(shape=24, stroke=0.5, size=1.5, colour="black", alpha=alphaLine) +
  scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
  scale_y_continuous("Receiver Prop. BS Called", limits=c(0,1), expand=c(0,0)) + 
  scale_colour_manual(values = my_red) +
  scale_fill_manual(values = my_red, labels=p_label) +
  guides(colour="none", fill=guide_legend(title="Base Rate:", override.aes=list(size=2, linetype=0, shape=21))) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        legend.position = "top",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

#HERE2
detectParamPlot <- detectMLE.pred %>%
  mutate(p = as.numeric(as.character(p)),
         payoff = ifelse(expt=="expt4", "Sender gets\npoints for red", "Sender gets\npoints for blue")) %>%
  bind_rows(data.frame(p=c(0.2,0.5,0.8), 
                       payoff="null", 
                       b=c(2, 5, 8))) %>%
  mutate(p.fact=paste("p =",p),
         payoff=fct_relevel(payoff, c("Sender gets\npoints for red", "null", "Sender gets\npoints for blue")),
         compare=ifelse(payoff=="null", TRUE, FALSE)) %>%
  ggplot(aes(x=b, y=p, pch=payoff)) +
  geom_line(aes(lty=compare)) +
  geom_errorbarh(aes(x=b, y=p, xmin=b-2*b.se, xmax=b+2*b.se), height=0.06) +
  geom_point(aes(fill=p.fact), size=2) +
  scale_y_continuous("Base Rate Probability", limits=c(0,1), breaks=c(0.2,0.5,0.8), expand=c(0,0)) +
  scale_x_continuous("Implied Mode of Distribution of True Reports", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
  scale_shape_manual(values=c(22,21,24)) +
  scale_linetype_discrete(guide="none") +
  scale_fill_manual(values = my_red, guide="none") +
  guides(shape=guide_legend(title="")) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        legend.position="top",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        #axis.title.y = element_text(angle=0, vjust=0.5),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,4.5,0,2)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

legend_param <- get_legend(detectParamPlot)
legend_horiz <- get_legend(detect.results_expt5)

# pair results with model parameter

detectplots_results_full <- plot_grid( 
  detect.results_expt4 + ggtitle("Sender Gets Points for Red") + 
    scale_x_continuous("Reported Marbles", limits=c(0,10), breaks=seq(0,10,1), expand=c(0,0)) +
    theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold")),
  ggdraw(),
  detect.results_expt5 + ggtitle("Sender Gets Points for Blue") + 
    theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold"),
        legend.position="none"), 
  ggdraw(),
  detectParamPlot + ggtitle("Receiver's Believed Mode of True Reports") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.05, face = "bold"),
        legend.position="none"),
  nrow=5,
  rel_heights=c(1, 0.01, 1, 0.05, 1.5))

detectorLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.94, x=0.5, hjust=0, angle=270)

detectrow_results <- plot_grid(detectplots_results_full, detectorLabel, nrow=1, rel_widths=c(94, 6))

withLegend_results <- ggdraw() +
  draw_plot(detectrow_results) +
  draw_plot(legend_horiz, x=0.04, y=0.45) +
  draw_plot(legend_param, x=0.04, y=-0.14) +
  draw_label("a)", size=10, x=0.1, y=0.99) +
  draw_label("b)", size=10, x=0.1, y=0.705) +
  draw_label("c)", size=10, x=0.1, y=0.41)
  
ggsave("img/detectResultsParam_horiz2.pdf", 
       withLegend_results, 
       units="cm", height=16, width=8.7)
```

```{r}
# ANOVA

matr_b.se
matr_b.mean


## compare utility conditions - z-test
twosampztest <- function(mu1, sd1, mu2, sd2){
  (mu1 - mu2)/sqrt(sd1^2 + sd2^2)
}

sumsd <- function(sds){
  sqrt(sum(sds^2)/3^2)
}

# differences between utility conditions
z_mean.b <- twosampztest(mean(matr_b.mean[,'red']), sumsd(matr_b.se[,'red']),
             mean(matr_b.mean[,'blue']), sumsd(matr_b.se[,'blue']))
z_mean.b
2*pnorm(z_mean.b, lower.tail=TRUE)

z_0.2.red.null <- twosampztest(matr_b.mean['p=0.2','red'], matr_b.se['p=0.2','red'],
                      2, 0)
z_0.2.red.null
2*pnorm(z_0.2.red.null, lower.tail=FALSE)

z_0.2.blue.null <- twosampztest(matr_b.mean['p=0.2','blue'], matr_b.se['p=0.2','blue'],
                      2, 0)
z_0.2.blue.null
2*pnorm(z_0.2.blue.null, lower.tail=FALSE)


z_0.5.red.null <- twosampztest(matr_b.mean['p=0.5','red'], matr_b.se['p=0.5','red'],
                      5, 0)
z_0.5.red.null
2*pnorm(z_0.5.red.null, lower.tail=TRUE)

z_0.5.blue.null <- twosampztest(matr_b.mean['p=0.5','blue'], matr_b.se['p=0.5','blue'],
                      5, 0)
z_0.5.blue.null
2*pnorm(z_0.5.blue.null, lower.tail=FALSE)


z_0.8.red.null <- twosampztest(matr_b.mean['p=0.8','red'], matr_b.se['p=0.8','red'],
                      8, 0)
z_0.8.red.null
2*pnorm(z_0.8.red.null, lower.tail=TRUE)

z_0.8.blue.null <- twosampztest(matr_b.mean['p=0.8','blue'], matr_b.se['p=0.8','blue'],
                      8, 0)
z_0.8.blue.null
2*pnorm(z_0.8.blue.null, lower.tail=FALSE)
```




```{r message=FALSE, warning=FALSE}
humanLie <- bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  mutate(condition = paste0(probabilityRed,"_",expt))

logitToProb <- function(logit){
  exp(logit) / (1+exp(logit))
}

probToLogit <- function(prob){
  log(prob / (1 - prob))
}

# w = b + a
# u = a / (b + a)


lieLogisticModel <- function(k, beta, mu){
  logodds = beta * (k-mu)
  logitToProb(pmin(10, pmax(-10, logodds)))
}

p.lie.k <- function(k, beta, mu){
  lieLogisticModel(k, beta, mu)
}


p.kstar.k <- function(k, kstar, alph){
  alph = logitToProb(alph)
  dbinom(kstar, 10, alph) / (1-dbinom(k, 10, alph))  
}

lieLogisticBinom <- function(k, kstar, beta, mu, alph){
  p.lie = p.lie.k(k, beta, mu)
  ifelse(k == kstar, 1 - p.lie, p.lie * p.kstar.k(k, kstar, alph))
}
.005
lieLogisticBinom(humanLie$drawnRed[1], humanLie$reportedDrawn[1], .02, 63, -0.6)


nLL <- function(beta, mu0.2_4, alph0.2_4,
                      mu0.5_4, alph0.5_4,
                      mu0.8_4, alph0.8_4,
                      mu0.2_5, alph0.2_5,
                      mu0.5_5, alph0.5_5,
                      mu0.8_5, alph0.8_5){
  k = humanLie$drawnRed
  kstar = humanLie$reportedDrawn
  expt = humanLie$expt
  prob = humanLie$probabilityRed
  mu = case_when(
    prob == 0.2 & expt == "expt4" ~ mu0.2_4,
    prob == 0.5 & expt == "expt4" ~ mu0.5_4,
    prob == 0.8 & expt == "expt4" ~ mu0.8_4,
    prob == 0.2 & expt == "expt5" ~ mu0.2_5,
    prob == 0.5 & expt == "expt5" ~ mu0.5_5,
    prob == 0.8 & expt == "expt5" ~ mu0.8_5
   )
  alph = case_when(
    prob == 0.2 & expt == "expt4" ~ alph0.2_4,
    prob == 0.5 & expt == "expt4" ~ alph0.5_4,
    prob == 0.8 & expt == "expt4" ~ alph0.8_4,
    prob == 0.2 & expt == "expt5" ~ alph0.2_5,
    prob == 0.5 & expt == "expt5" ~ alph0.5_5,
    prob == 0.8 & expt == "expt5" ~ alph0.8_5
   )
  
  betas = ifelse(expt=="expt4", 1*beta, -1*beta)
  
  pred = lieLogisticBinom(k, kstar, betas, mu, alph)
  # likelihood of observed kstar for that k, given parameters
  neg.log.lik = -1*sum(log(pred))
  mus = c(mu0.2_4, mu0.5_4, mu0.8_4, mu0.2_5, mu0.5_5, mu0.8_5)
  alphas = c(alph0.2_4, alph0.5_4, alph0.8_4, alph0.2_5, alph0.5_5, alph0.8_5)
  #neg.log.prior = sum(.0001*(mus-5)^2)-abs(beta)+ sum(alphas^2)+u*10
  neg.log.prior = 0
  neg.log.lik+neg.log.prior
}

# as bernoulli instead of if statement


fit <- summary(mle(nLL,
           start=list(beta=rnorm(1, 0, 0.5),
                      mu0.2_4=rnorm(1, 5, 3),
                      alph0.2_4=rnorm(1, 0, 0.5),
                      mu0.5_4=rnorm(1, 5, 3),
                      alph0.5_4=rnorm(1, 0, 0.5),
                      mu0.8_4=rnorm(1, 5, 3),
                      alph0.8_4=rnorm(1, 0, 0.5),
                      mu0.2_5=rnorm(1, 5, 3),
                      alph0.2_5=rnorm(1, 0, 0.5),
                      mu0.5_5=rnorm(1, 5, 3),
                      alph0.5_5=rnorm(1, 0, 0.5),
                      mu0.8_5=rnorm(1, 5, 3),
                      alph0.8_5=rnorm(1, 0, 0.5)),
           method = "BFGS"))
fit
round(coef(fit),5)
```




```{r}
binom.p <- function(kstar, alph){
  alph = logitToProb(alph)
  dbinom(kstar, 10, alph)
}

lieMLE.pred <- data.frame(k=rep(rep(0:10,each=11),3*2), 
                          kstar=rep(0:10, 11*3*2),
                          p=as.factor(rep(c(rep(0.2,11*11), rep(0.5,11*11), rep(0.8,11*11)),2)),
                          expt=as.factor(c(rep("expt4",11*11*3), rep("expt5",11*11*3))),
                          betas=c(rep(fit@coef["beta","Estimate"],11*11*3*2)),
                          mu=c(rep(fit@coef["mu0.2_4","Estimate"],11*11),
                               rep(fit@coef["mu0.5_4","Estimate"],11*11),
                               rep(fit@coef["mu0.8_4","Estimate"],11*11),
                               rep(fit@coef["mu0.2_5","Estimate"],11*11),
                               rep(fit@coef["mu0.5_5","Estimate"],11*11),
                               rep(fit@coef["mu0.8_5","Estimate"],11*11)),
                          mu.se=c(rep(fit@coef["mu0.2_4","Std. Error"],11*11),
                                  rep(fit@coef["mu0.5_4","Std. Error"],11*11),
                                  rep(fit@coef["mu0.8_4","Std. Error"],11*11),
                                  rep(fit@coef["mu0.2_5","Std. Error"],11*11),
                                  rep(fit@coef["mu0.5_5","Std. Error"],11*11),
                                  rep(fit@coef["mu0.8_5","Std. Error"],11*11)),
                          alph=c(rep(fit@coef["alph0.2_4","Estimate"],11*11),
                                 rep(fit@coef["alph0.5_4","Estimate"],11*11),
                                 rep(fit@coef["alph0.8_4","Estimate"],11*11),
                                 rep(fit@coef["alph0.2_5","Estimate"],11*11),
                                 rep(fit@coef["alph0.5_5","Estimate"],11*11),
                                 rep(fit@coef["alph0.8_5","Estimate"],11*11)),
                          alph.se=c(rep(fit@coef["alph0.2_4","Std. Error"],11*11),
                                    rep(fit@coef["alph0.5_4","Std. Error"],11*11),
                                    rep(fit@coef["alph0.8_4","Std. Error"],11*11),
                                    rep(fit@coef["alph0.2_5","Std. Error"],11*11),
                                    rep(fit@coef["alph0.5_5","Std. Error"],11*11),
                                    rep(fit@coef["alph0.8_5","Std. Error"],11*11))) %>%
  mutate(betas = ifelse(expt=="expt5", -betas, betas),
         p.lie.k = p.lie.k(k, betas, mu),
         p.kstar.k=lieLogisticBinom(k, kstar, betas, mu, alph),
         binom.kstar = binom.p(kstar, alph),
         logp.kstar.k = log(p.kstar.k))

lieMLE.pred %>%
  group_by(p, expt, k) %>%
  summarise(mean.kstar = sum(kstar*p.kstar.k)) %>%
  ggplot(aes(x=k, y=mean.kstar, colour=p)) +
  geom_line() +
  facet_wrap(~expt)


exptLie <- humanLie %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, expt, drawnRed, reportedDrawn) %>%
  summarise(n = n(),
            truth = sum(drawnRed == reportedDrawn)) %>%
  ungroup() %>%
  group_by(probabilityRed.txt, expt, drawnRed) %>%
  mutate(p.kstar.k = n/sum(n),
         fit="experiment")
lieMLE.2 <- data.frame(probabilityRed.txt = paste("p =", lieMLE.pred$p),
                               expt = lieMLE.pred$expt,
                               drawnRed = lieMLE.pred$k,
                               reportedDrawn = lieMLE.pred$kstar,
                               p.kstar.k = lieMLE.pred$p.kstar.k,
                               n = NA,
                               fit = "model")
lie.full <- bind_rows(exptLie, lieMLE.2)

lie.full %>%
  group_by(fit, probabilityRed.txt, expt, drawnRed) %>%
  summarise(mean.reported = sum(reportedDrawn*p.kstar.k)) %>%
  ggplot(aes(x=drawnRed, y=mean.reported, colour=probabilityRed.txt, linetype=fit)) +
  geom_line() +
  geom_abline(intercept = 0, slope = 1, colour="darkgray", linetype=4) +
  facet_wrap(~expt)

ggsave("img/fit_expt_modelLie.png")
```

```{r}
lieMLE.3 <- data.frame(probabilityRed.txt = paste("p =", lieMLE.pred$p),
                       expt = lieMLE.pred$expt,
                       drawnRed = lieMLE.pred$k,
                       p.lie.k = lieMLE.pred$p.lie.k,
                       se = NA,
                       n = NA,
                       fit = "model") %>%
  unique()
exptLie.3 <- humanLie %>%
  mutate(probabilityRed.txt = paste("p =", probabilityRed)) %>%
  group_by(probabilityRed.txt, expt, drawnRed) %>%
  summarise(p.lie.k = sum(drawnRed != reportedDrawn)/n(),
            se = sqrt(p.lie.k*(1-p.lie.k)/n()),
            n = n()) %>%
  mutate(fit="experiment")

lie.3.full <- bind_rows(lieMLE.3, exptLie.3)


ggplot(data=lie.3.full, aes(x=drawnRed, y=p.lie.k, colour=probabilityRed.txt, linetype=fit)) +
  geom_point(data=filter(lie.3.full, fit=="experiment")) +
  geom_line() +
  geom_errorbar(data=filter(lie.3.full, fit=="experiment"), aes(x=drawnRed, colour=probabilityRed.txt, min=p.lie.k-se, max=p.lie.k+se), width=.3) +
  scale_x_continuous("Actual Marbles Drawn", limits=c(-0.2,10.2)) +
  scale_y_continuous("Proportion Lie", limits=c(0,1)) +
  guides(colour=guide_legend(title="")) +
  facet_wrap(~expt) +
  theme_minimal()

ggsave("img/fit_expt_modelWhenLie.png")
```

```{r}
x = -20:35
data.frame(p=as.factor(rep(c(rep(0.2,length(x)), rep(0.5,length(x)), rep(0.8,length(x))),2)),
           expt=as.factor(c(rep("expt4",length(x)*3), rep("expt5",length(x)*3))),
           x=rep(x,6),
           beta=fit@coef["beta","Estimate"],
           mu=c(rep(fit@coef["mu0.2_4","Estimate"],length(x)),
                rep(fit@coef["mu0.5_4","Estimate"],length(x)),
                rep(fit@coef["mu0.8_4","Estimate"],length(x)),
                rep(fit@coef["mu0.2_5","Estimate"],length(x)),
                rep(fit@coef["mu0.5_5","Estimate"],length(x)),
                rep(fit@coef["mu0.8_5","Estimate"],length(x)))) %>%
  mutate(beta = ifelse(expt=="expt5", -beta, beta),
         p.lie.k = p.lie.k(x, beta, mu)) %>%
  ggplot(aes(x=x, y=p.lie.k, colour=p)) +
  geom_line() +
  geom_vline(xintercept=0, linetype=2) +
  geom_vline(xintercept=10, linetype=2) +
  scale_y_continuous(limits=c(0,1)) +
  facet_wrap(~expt) +
  theme_minimal()
ggsave("img/fit_expt_modelWhenLieWide.png")
```

```{r}
lieColors = c("truth" = "springgreen3",
              "lie" = "red3")

propLieGiven <- bs.final %>%
  filter(expt %in% c("expt4","expt5"), roleCurrent == "bullshitter") %>%
  mutate(probabilityRed = factor(paste0((probabilityRed*100), "% red"))) %>%
  group_by(expt, probabilityRed, drawnRed, reportedDrawn) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(expt, probabilityRed, drawnRed) %>%
  mutate(total = sum(n),
         prop = n/sum(n),
         meanLie = sum(reportedDrawn * prop),
         logprop = log(n),
         logitprop = log(prop/(1-prop)),
         lie = ifelse(drawnRed != reportedDrawn, "lie", "truth"))

p4 <- propLieGiven %>%
  filter(expt == "expt4") %>%
  ggplot(aes(x=reportedDrawn, y=prop, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Sender Gets Points for Red") +
  scale_x_continuous("Reported Value", breaks=seq(0,10,2)) +
  scale_y_continuous("Proportion of Reports Conditioned on True Value", breaks=seq(0,1,0.5), labels=c("0","0.5","1")) +
  scale_fill_manual("",values=lieColors) +
  coord_flip(clip="off") +
  facet_grid(probabilityRed ~ drawnRed) +
  theme_bw() +
  theme(axis.text = element_text(size=8)) +
  geom_text(data=data.frame(probabilityRed="20% red", drawnRed=0, lie=NA), x=13, y=-1.15, size=2.5, hjust=0, label="True\nSample:")
g4 <- ggplot_gtable(ggplot_build(p4))
stripr <- which(grepl('strip-r', g4$layout$name))
k <- 1
for (i in stripr) {
  j <- which(grepl('rect', g4$grobs[[i]]$grobs[[1]]$childrenOrder))
  g4$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- my_red[k]
  k <- k+1
}

ggsave("img/lieSpike/raw_modelLieSpike_expt4.png", g4, width=7, height=4)
```

```{r}
p5 <- propLieGiven %>%
  filter(expt == "expt5") %>%
  ggplot(aes(x=reportedDrawn, y=prop, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Sender Gets Points for Blue") +
  scale_x_continuous("Reported Value", breaks=seq(0,10,2)) +
  scale_y_continuous("Proportion of Reports Conditioned on True Value", breaks=seq(0,1,0.5), labels=c("0","0.5","1")) +
  scale_fill_manual("",values=lieColors) +
  coord_flip(clip="off") +
  facet_grid(probabilityRed ~ drawnRed) +
  theme_bw() +
  theme(axis.text = element_text(size=8)) +
  geom_text(data=data.frame(probabilityRed="20% red", drawnRed=0, lie=NA), x=13, y=-1, size=2.5, hjust=0, label="True\nSample:")
g5 <- ggplot_gtable(ggplot_build(p5))
stripr <- which(grepl('strip-r', g5$layout$name))
k <- 1
for (i in stripr) {
  j <- which(grepl('rect', g5$grobs[[i]]$grobs[[1]]$childrenOrder))
  g5$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- my_red[k]
  k <- k+1
}
ggsave("img/lieSpike/raw_modelLieSpike_expt5.png", g5, width=7, height=4)
```

# Binomial distribution of k\* for each condition from MLE parameters

```{r}
lieMLE.pred %>%
  filter(expt=="expt4") %>%
  mutate(lie = ifelse(k != kstar, "lie", "truth")) %>%
  ggplot(aes(x=kstar, y=p.kstar.k, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Fit Expt 4 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)
ggsave("img/fit_expt_modelLieSpike_expt4.png")
```

```{r}
lieMLE.pred %>%
  filter(expt=="expt5") %>%
  mutate(lie = ifelse(k != kstar, "lie", "truth")) %>%
  ggplot(aes(x=kstar, y=p.kstar.k, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Fit Expt 5 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)
ggsave("img/fit_expt_modelLieSpike_expt5.png")
```

```{r}
ggplot(lieMLE.pred, aes(x=kstar, y=binom.kstar, colour=p)) +
  geom_line() +
  facet_grid(expt~.)
```

```{r}
bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  mutate(probabilityRed = factor(paste0((probabilityRed*100), "% red")),
         expt = ifelse(expt=="expt4", "Sender gets points for red", "Sender gets points for blue"),
         expt = fct_relevel(expt, c("Sender gets points for red", "Sender gets points for blue"))) %>%
  select(subjID, probabilityRed, expt, drawnRed, reportedDrawn) %>%
  gather("type","value",4:5) %>%
  mutate(type = ifelse(type=="drawnRed", "true", "reported"),
         type = fct_relevel(type, c("true","reported"))) %>%
  ggplot(aes(x=value, fill=type)) +
  geom_bar(position="identity", alpha=0.3) +
  geom_density(aes(y=..count..), adjust=2, alpha=0.3) +
  scale_x_continuous("# of red marbles",breaks=seq(0,10,2), expand=c(0,0)) +
  scale_y_continuous("Counts", expand=c(0,0,0,40)) +
  scale_fill_manual("", values=c("steelblue1","green4")) +
  facet_grid(expt ~ probabilityRed) +
  theme_bw()
```

Delta from the truth

```{r}
humanDelta <- bs.final %>%
  filter(roleCurrent == "bullshitter") %>%
  mutate(probabilityRed = factor(paste0((probabilityRed*100), "% red")),
         expt = ifelse(expt=="expt4", "Sender gets points for red", "Sender gets points for blue"),
         expt = fct_relevel(expt, c("Sender gets points for red", "Sender gets points for blue")),
         delta = reportedDrawn - drawnRed) %>%
  ggplot(aes(x=delta)) +
  geom_bar(colour="black") +
  ggtitle("Human Results") +
  scale_x_continuous("k = Reported - True") +
  scale_y_continuous("Count") +
  facet_grid(expt ~ probabilityRed) +
  theme_bw()

# recursiveToMDelta <- recursiveToM_sender %>%
#   ungroup() %>%
#   mutate(probK = dbinom(k,10,p),
#          p = factor(paste0((p*100), "% red")),
#          expt = ifelse(expt=="expt4", "Sender gets points for red", "Sender gets points for blue"),
#          expt = fct_relevel(expt, c("Sender gets points for red", "Sender gets points for blue")),
#          delta = ksay - k,
#          weightedVal = probK * meanVal) %>%
#   group_by(p, expt, delta) %>%
#   summarise(sum = sum(weightedVal)) %>%
#   ggplot(aes(x=delta,y=sum)) +
#   geom_bar(stat="identity", colour="black") +
#   ggtitle("Recursive ToM") +
#   scale_x_continuous(" (reported k* - true k)") +
#   scale_y_continuous("Predicted Density", limits=c(0,1)) +
#   facet_grid(expt ~ p) +
#   theme_bw()
# 
# recursiveToMAversionDelta <- recursiveToM.aversion_sender %>%
#   ungroup() %>%
#   mutate(probK = dbinom(k,10,p),
#          p = factor(paste0((p*100), "% red")),
#          expt = ifelse(expt=="expt4", "Sender gets points for red", "Sender gets points for blue"),
#          expt = fct_relevel(expt, c("Sender gets points for red", "Sender gets points for blue")),
#          delta = ksay - k,
#          weightedVal = probK * meanVal) %>%
#   group_by(p, expt, delta) %>%
#   summarise(sum = sum(weightedVal)) %>%
#   ggplot(aes(x=delta,y=sum)) +
#   geom_bar(stat="identity", colour="black") +
#   ggtitle("Recursive ToM + Aversion") +
#   scale_x_continuous(" (reported k* - true k)") +
#   scale_y_continuous("Predicted Density", limits=c(0,1)) +
#   facet_grid(expt ~ p) +
#   theme_bw()
```

```{r}
lieMLE.pred %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(p_expt = paste0(p, "_", expt),
         meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=p, y=meanAlph, fill=expt)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(x=p, fill=expt, min=10*logitToProb(alph-alph.se), max=10*logitToProb(alph+alph.se)), width=.3, position=position_dodge(.9)) +
  scale_y_continuous("Mean Lie", limits=c(0,10))
```

```{r}
MLEparams <- lieMLE.pred %>%
  group_by(p, expt) %>%
  select(mu, mu.se, alph, alph.se) %>%
  mutate(meanAlph = 10*logitToProb(alph),
         meanAlph.lower = 10*logitToProb(alph - alph.se),
         meanAlph.upper = 10*logitToProb(alph + alph.se),
         meanAlph.CIlower = 10*logitToProb(alph - 1.96*alph.se),
         meanAlph.CIupper = 10*logitToProb(alph + 1.96*alph.se)) %>%
  unique()

MLEparams

# one sided 2 sample t test with pooled variance
wald.z.test <- function(m1, sd1, m2, sd2){
  z <- (m1 - m2) / sqrt(sd1^2 + sd2^2)
  p <- pnorm(abs(z), lower.tail=F) 
  signif <- p < .05
  return(data.frame(m1, sd1, m2, sd2, z, p, signif))
}

#Comparing mus

# ANOVA

matr_mu.se <- matrix(MLEparams$mu.se, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))
matr_mu.mean <- matrix(MLEparams$mu, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))
matr_alph.se <- matrix(MLEparams$alph.se, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))
matr_alph.mean <- matrix(MLEparams$alph, 3, dimnames=list(c("p=0.2","p=0.5","p=0.8"), c("red","blue")))

# alph

## compare utility conditions - z-test
twosampztest <- function(mu1, sd1, mu2, sd2){
  (mu1 - mu2)/sqrt(sd1^2 + sd2^2)
}



# meancomb <- function(mus, sds){
#   sum(mus/sds^2)/sum(1/sds^2)
# }
# 
# meancomb(matr_alph.mean[,'red'], matr_alph.se[,'red'])

sumsd <- function(sds){
  sqrt(sum(sds^2)/3^2)
}

# differences between utility conditions
z_mean <- twosampztest(mean(matr_alph.mean[,'red']), sumsd(matr_alph.se[,'red']),
             mean(matr_alph.mean[,'blue']), sumsd(matr_alph.se[,'blue']))
z_mean
2*pnorm(z_mean, lower.tail=FALSE)

z_0.2 <- twosampztest(matr_alph.mean['p=0.2','red'], matr_alph.se['p=0.2','red'],
                      matr_alph.mean['p=0.2','blue'], matr_alph.se['p=0.2','blue'])
z_0.2
2*pnorm(z_0.2, lower.tail=FALSE)

z_0.5 <- twosampztest(matr_alph.mean['p=0.5','red'], matr_alph.se['p=0.5','red'],
                      matr_alph.mean['p=0.5','blue'], matr_alph.se['p=0.5','blue'])
z_0.5
2*pnorm(z_0.5, lower.tail=FALSE)

z_0.8 <- twosampztest(matr_alph.mean['p=0.8','red'], matr_alph.se['p=0.8','red'],
                      matr_alph.mean['p=0.8','blue'], matr_alph.se['p=0.8','blue'])
z_0.8
2*pnorm(z_0.8, lower.tail=FALSE)




## compare probability conditions
chisqu <- function(mus, sds){
  mu_red = meancomb(mus[1:3], sds[1:3])
  mu_blue = meancomb(mus[4:6], sds[4:6])
  sum(((mus[1:3] - mu_red)/sds[1:3])^2) + sum(((mus[4:6] - mu_blue)/sds[4:6])^2)
}

(truechi <- chisqu(as.vector(matr_alph.mean), as.vector(matr_alph.se)))
(pchi <- pchisq(truechi, df=4, lower.tail=FALSE))

## simulate chi-square
n = 10000
simChiSq <- data.frame(n=numeric(),
                       i=numeric(),
                       j=numeric(),
                       mu=numeric(),
                       chisq=numeric())
for(i in 1:n){
  means = rnorm(6,0,as.vector(matr_alph.se))
  chi = chisqu(means, as.vector(matr_alph.se))
  newdf = data.frame(n=i,
                     i=rep(1:3, 2),
                     j=rep(1:2, each=3),
                     mu = means,
                     chisq = chi)
  simChiSq = bind_rows(simChiSq, newdf)
}

orderedSim <- simChiSq %>%
  select(n, chisq) %>%
  group_by(n) %>%
  unique() %>%
  arrange(chisq)

ggplot(orderedSim, aes(x=chisq)) +
  geom_density() +
  geom_vline(xintercept=orderedSim$chisq[9500], colour="red") +
  ggtitle("Simulated chi-square (df=4) distribution")

ggplot(orderedSim, aes(x=chisq)) +
  geom_density() +
  geom_vline(xintercept=truechi, linetype=2) +
  scale_x_continuous(limits=c(0,2500))

max(orderedSim$chisq)
max(orderedSim$chisq) < truechi

# true chi-square distribution
chisample <- data.frame(x=rchisq(100000, 4)) %>%
  arrange(x)
ggplot(chisample, aes(x=x)) +
  geom_density() +
  geom_vline(xintercept=chisample$x[95000], colour="red") +
  ggtitle("Chi-square (df=4) distribution")
```

```{r}
# no differences between mus (frequency of lying)?

z_mean_mu <- twosampztest(mean(matr_mu.mean[,'red']), sumsd(matr_mu.se[,'red']),
             mean(matr_mu.mean[,'blue']), sumsd(matr_mu.se[,'blue']))
z_mean_mu
2*pnorm(abs(z_mean_mu), lower.tail=FALSE)

(truechi_mu <- chisqu(as.vector(matr_mu.mean), as.vector(matr_mu.se)))
(pchi_mu <- pchisq(truechi_mu, df=4, lower.tail=FALSE))

## simulate chi-square
n = 10000
simChiSq_mu <- data.frame(n=numeric(),
                       i=numeric(),
                       j=numeric(),
                       mu=numeric(),
                       chisq=numeric())
for(i in 1:n){
  means = rnorm(6,0,as.vector(matr_mu.se))
  chi = chisqu(means, as.vector(matr_mu.se))
  newdf = data.frame(n=i,
                     i=rep(1:3, 2),
                     j=rep(1:2, each=3),
                     mu = means,
                     chisq = chi)
  simChiSq_mu = bind_rows(simChiSq_mu, newdf)
}

orderedSim_mu <- simChiSq_mu %>%
  select(n, chisq) %>%
  group_by(n) %>%
  unique() %>%
  arrange(chisq)

ggplot(orderedSim_mu, aes(x=chisq)) +
  geom_density() +
  geom_vline(xintercept=orderedSim_mu$chisq[9500], colour="red")

ggplot(orderedSim_mu, aes(x=chisq)) +
  geom_density() +
  geom_vline(xintercept=truechi_mu, linetype=2) +
  scale_x_continuous(limits=c(0,75))
```

# Model predictions about liar's likelihood to lie

```{r}
# It is not very intuitive what this means
moral = 0
Expt = 4
recurse_propLie_expt4 <- data.frame(role = "Liar",
                              model="recursive ",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt4",
                              val=c(p.lie.k.fromDet(0.2, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.2)$val),
                                    p.lie.k.fromDet(0.5, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.5)$val),
                                    p.lie.k.fromDet(0.8, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.8)$val)))
Expt = 5
recurse_propLie_expt5 <- data.frame(role = "Liar",
                              model="recursive ",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt5",
                              val=c(p.lie.k.fromDet(0.2, filter(df.unif, role=="Detector" & mor==0 & expt=="expt5" & p==0.2)$val),
                                    p.lie.k.fromDet(0.5, filter(df.unif, role=="Detector" & mor==0 & expt=="expt5" & p==0.5)$val),
                                    p.lie.k.fromDet(0.8, filter(df.unif, role=="Detector" & mor==0 & expt=="expt5" & p==0.8)$val)))
recurse_propLie <- bind_rows(recurse_propLie_expt4, recurse_propLie_expt5)


moral = 20
Expt = 4
averse_propLie_expt4 <- data.frame(role = "Liar",
                              model="recursive+aversion",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt4",
                              val=c(p.lie.k.fromDet(0.2, filter(df.unif, role=="Detector" & mor==20 & expt=="expt4" & p==0.2)$val),
                                    p.lie.k.fromDet(0.5, filter(df.unif, role=="Detector" & mor==20 & expt=="expt4" & p==0.5)$val),
                                    p.lie.k.fromDet(0.8, filter(df.unif, role=="Detector" & mor==20 & expt=="expt4" & p==0.8)$val)))
Expt = 5
averse_propLie_expt5 <- data.frame(role = "Liar",
                              model="recursive+aversion",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt5",
                              val=c(p.lie.k.fromDet(0.2, filter(df.unif, role=="Detector" & mor==20 & expt=="expt5" & p==0.2)$val),
                                    p.lie.k.fromDet(0.5, filter(df.unif, role=="Detector" & mor==20 & expt=="expt5" & p==0.5)$val),
                                    p.lie.k.fromDet(0.8, filter(df.unif, role=="Detector" & mor==20 & expt=="expt5" & p==0.8)$val)))
averse_propLie <- bind_rows(averse_propLie_expt4, averse_propLie_expt5)


moral = 0
Expt = 4
randOpp_propLie_expt4 <- data.frame(role = "Liar",
                              model = "random opponent",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt4",
                              val=c(p.lie.k.fromDet(0.2, rep(bonddepaulo, 11)),
                                    p.lie.k.fromDet(0.5, rep(bonddepaulo, 11)),
                                    p.lie.k.fromDet(0.8, rep(bonddepaulo, 11))))
Expt = 5
randOpp_propLie_expt5 <- data.frame(role = "Liar",
                              model = "random opponent",
                              p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
                              ks=rep(0:10,3),
                              expt = "expt5",
                              val=c(p.lie.k.fromDet(0.2, rep(bonddepaulo, 11)),
                                    p.lie.k.fromDet(0.5, rep(bonddepaulo, 11)),
                                    p.lie.k.fromDet(0.8, rep(bonddepaulo, 11))))
randOpp_propLie <- bind_rows(randOpp_propLie_expt4, randOpp_propLie_expt5)


propLie.models <- bind_rows(randOpp_propLie, recurse_propLie, averse_propLie) %>%
  mutate(p=paste0("p = ", p))

propLies.modelsFig <- propLie.models %>%
  filter(expt == "expt4") %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line() +
  scale_x_continuous("Actual Marbles Drawn") +
  scale_y_continuous("Proportion Lie", limits=c(0,1)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  facet_wrap(~model) +
  theme_bw()

propLies_wFit <- lie.3.full %>%
  filter(expt == "expt4") %>%
  ggplot(aes(x=drawnRed, y=p.lie.k, colour=probabilityRed.txt, linetype=fit)) +
  geom_point(data=filter(lie.3.full, fit=="experiment" & expt == "expt4")) +
  geom_line() +
  geom_errorbar(data=filter(lie.3.full, fit=="experiment" & expt == "expt4"), aes(x=drawnRed, colour=probabilityRed.txt, min=p.lie.k-se, max=p.lie.k+se), width=.3) +
  ggtitle("Human Results") +
  scale_x_continuous("", limits=c(-0.2,10.2)) +
  scale_y_continuous("", limits=c(0,1)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  guides(colour=guide_legend(title="")) +
  theme_minimal() +
  theme(legend.position = "none")
propLies_wFit

plot_grid(propLies.modelsFig, propLies_wFit, nrow=1, rel_widths=c(6, 4))
ggsave("img/lierate_expt4.png")


propLies.modelsFig5 <- propLie.models %>%
  filter(expt == "expt5") %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line() +
  scale_x_continuous("Actual Marbles Drawn") +
  scale_y_continuous("Proportion Lie", limits=c(0,1)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  facet_wrap(~model) +
  theme_bw()

propLies_wFit5 <- lie.3.full %>%
  filter(expt == "expt5") %>%
  ggplot(aes(x=drawnRed, y=p.lie.k, colour=probabilityRed.txt, linetype=fit)) +
  geom_point(data=filter(lie.3.full, fit=="experiment" & expt == "expt5")) +
  geom_line() +
  geom_errorbar(data=filter(lie.3.full, fit=="experiment" & expt == "expt5"), aes(x=drawnRed, colour=probabilityRed.txt, min=p.lie.k-se, max=p.lie.k+se), width=.3) +
  ggtitle("Human Results") +
  scale_x_continuous("", limits=c(-0.2,10.2)) +
  scale_y_continuous("", limits=c(0,1)) +
  scale_colour_manual(values = condColors.diff, guide="none") +
  guides(colour=guide_legend(title="")) +
  theme_minimal() +
  theme(legend.position = "none")
propLies_wFit5

plot_grid(propLies.modelsFig5, propLies_wFit5, nrow=1, rel_widths=c(6, 4))
ggsave("img/lierate_expt5.png")
```

# Plot mean lie given (p in Binomial distribution)

```{r}
moral = 0
matr0.2 <- log(p.L_ksay.k.r(0.2, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.2)$val))
hist3D(z=matr0.2, border="black")
matr0.5 <- log(p.L_ksay.k.r(0.5, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.5)$val))
hist3D(z=matr0.5, border="black")
matr0.8 <- log(p.L_ksay.k.r(0.8, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.8)$val))
hist3D(z=matr0.8, border="black")
```

```{r message=FALSE, warning=FALSE}
#p.L_ksay.k.r(0.5, filter(df.unif, role=="Detector" & mor==0 & expt=="expt4" & p==0.5)$val)

moral = 0
liesFromDetect <- function(model, exptNum, prob){
  if(model=="recurse"){
    detectRate = filter(df.unif, role=="Detector" & mor==0 & expt==paste0("expt",exptNum) & p==prob)$val
  } else if(model=="random opponent"){
    detectRate = rep(bonddepaulo, 11)
  }
  lieMatr <- p.L_ksay.k.r(prob, detectRate)
  data.frame(model=model,
             expt=paste0("expt",exptNum),
             p=prob,
             k=rep(0:10, each=11),
             k.star=rep(0:10, 11),
             prob.k.star = as.vector(lieMatr))
}

Expt = 4
recurseLie_expt4 <- bind_rows(liesFromDetect("recurse", 4, 0.2),
                              liesFromDetect("recurse", 4, 0.5),
                              liesFromDetect("recurse", 4, 0.8))
Expt = 5
recurseLie_expt5 <- bind_rows(liesFromDetect("recurse", 5, 0.2),
                              liesFromDetect("recurse", 5, 0.5),
                              liesFromDetect("recurse", 5, 0.8))
recurseLie <- bind_rows(recurseLie_expt4, recurseLie_expt5) %>%
  mutate(lie = ifelse(k != k.star, "lie", "truth"))

Expt = 4
randomLie_expt4 <- bind_rows(liesFromDetect("random opponent", 4, 0.2),
                             liesFromDetect("random opponent", 4, 0.5),
                             liesFromDetect("random opponent", 4, 0.8))
Expt = 5
randomLie_expt5 <- bind_rows(liesFromDetect("random opponent", 5, 0.2),
                             liesFromDetect("random opponent", 5, 0.5),
                             liesFromDetect("random opponent", 5, 0.8))
randomLie <- bind_rows(randomLie_expt4, randomLie_expt5) %>%
  mutate(lie = ifelse(k != k.star, "lie", "truth"))


recurseLie %>%
  filter(expt == "expt4") %>%
  ggplot(aes(x=k.star, y=prob.k.star, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Recurse Model Expt 4 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)

recurseLie %>%
  filter(expt == "expt5") %>%
  ggplot(aes(x=k.star, y=prob.k.star, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Recurse Model Expt 5 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)

randomLie %>%
  filter(expt == "expt4") %>%
  ggplot(aes(x=k.star, y=prob.k.star, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Random Opponent Model Expt 4 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)

randomLie %>%
  filter(expt == "expt5") %>%
  ggplot(aes(x=k.star, y=prob.k.star, fill=lie)) +
  geom_bar(stat="identity") +
  ggtitle("Random Opponent Model Expt 5 k* | k") +
  scale_fill_manual(values=lieColors) +
  coord_flip() +
  facet_grid(p ~ k)
```



```{r}
countRecurseLie <- recurseLie %>%
  mutate(counts = floor(1000*prob.k.star*(0.8*dbinom(k, 10, p))+0.2*(1/11))) %>%
  uncount(weights=counts)

nLL_recurse <- function(beta, mu0.2_4, alph0.2_4,
                      mu0.5_4, alph0.5_4,
                      mu0.8_4, alph0.8_4,
                      mu0.2_5, alph0.2_5,
                      mu0.5_5, alph0.5_5,
                      mu0.8_5, alph0.8_5){
  k = countRecurseLie$k
  kstar = countRecurseLie$k.star
  expt = countRecurseLie$expt
  prob = countRecurseLie$p
  mu = case_when(
    prob == 0.2 & expt == "expt4" ~ mu0.2_4,
    prob == 0.5 & expt == "expt4" ~ mu0.5_4,
    prob == 0.8 & expt == "expt4" ~ mu0.8_4,
    prob == 0.2 & expt == "expt5" ~ mu0.2_5,
    prob == 0.5 & expt == "expt5" ~ mu0.5_5,
    prob == 0.8 & expt == "expt5" ~ mu0.8_5
   )
  alph = case_when(
    prob == 0.2 & expt == "expt4" ~ alph0.2_4,
    prob == 0.5 & expt == "expt4" ~ alph0.5_4,
    prob == 0.8 & expt == "expt4" ~ alph0.8_4,
    prob == 0.2 & expt == "expt5" ~ alph0.2_5,
    prob == 0.5 & expt == "expt5" ~ alph0.5_5,
    prob == 0.8 & expt == "expt5" ~ alph0.8_5
   )
  
  betas = ifelse(expt=="expt4", 1*beta, -1*beta)
  
  pred = lieLogisticBinom(k, kstar, betas, mu, alph)
  # likelihood of observed kstar for that k, given parameters
  neg.log.lik = -1*sum(log(pred))
  mus = c(mu0.2_4, mu0.5_4, mu0.8_4, mu0.2_5, mu0.5_5, mu0.8_5)
  alphas = c(alph0.2_4, alph0.5_4, alph0.8_4, alph0.2_5, alph0.5_5, alph0.8_5)
  #neg.log.prior = sum(.0001*(mus-5)^2)-abs(beta)+ sum(alphas^2)+u*10
  neg.log.prior = 0
  neg.log.lik+neg.log.prior
}



fit_recurse <- summary(mle(nLL_recurse,
           start=list(beta=rnorm(1, 0, 0.5),
                      mu0.2_4=rnorm(1, 5, 3),
                      alph0.2_4=rnorm(1, 0, 0.5),
                      mu0.5_4=rnorm(1, 5, 3),
                      alph0.5_4=rnorm(1, 0, 0.5),
                      mu0.8_4=rnorm(1, 5, 3),
                      alph0.8_4=rnorm(1, 0, 0.5),
                      mu0.2_5=rnorm(1, 5, 3),
                      alph0.2_5=rnorm(1, 0, 0.5),
                      mu0.5_5=rnorm(1, 5, 3),
                      alph0.5_5=rnorm(1, 0, 0.5),
                      mu0.8_5=rnorm(1, 5, 3),
                      alph0.8_5=rnorm(1, 0, 0.5)),
           method = "BFGS"))
fit_recurse

lieMLE.pred_recurse <- data.frame(k=rep(rep(0:10,each=11),3*2), 
                          kstar=rep(0:10, 11*3*2),
                          p=as.factor(rep(c(rep(0.2,11*11), rep(0.5,11*11), rep(0.8,11*11)),2)),
                          expt=as.factor(c(rep("expt4",11*11*3), rep("expt5",11*11*3))),
                          alph=c(rep(fit_recurse@coef["alph0.2_4","Estimate"],11*11),
                                 rep(fit_recurse@coef["alph0.5_4","Estimate"],11*11),
                                 rep(fit_recurse@coef["alph0.8_4","Estimate"],11*11),
                                 rep(fit_recurse@coef["alph0.2_5","Estimate"],11*11),
                                 rep(fit_recurse@coef["alph0.5_5","Estimate"],11*11),
                                 rep(fit_recurse@coef["alph0.8_5","Estimate"],11*11)),
                          alph.se=c(rep(fit_recurse@coef["alph0.2_4","Std. Error"],11*11),
                                    rep(fit_recurse@coef["alph0.5_4","Std. Error"],11*11),
                                    rep(fit_recurse@coef["alph0.8_4","Std. Error"],11*11),
                                    rep(fit_recurse@coef["alph0.2_5","Std. Error"],11*11),
                                    rep(fit_recurse@coef["alph0.5_5","Std. Error"],11*11),
                                    rep(fit_recurse@coef["alph0.8_5","Std. Error"],11*11))) %>%
  mutate(p.kstar.k = p.kstar.k(k, kstar, alph),
         binom.kstar = binom.p(kstar, alph),
         alph.asProb = logitToProb(alph))

ggplot(lieMLE.pred_recurse, aes(x=kstar, y=binom.kstar, colour=p)) +
  geom_line() +
  facet_grid(expt~.)
```

```{r}
countRandomLie <- randomLie %>%
  mutate(counts = floor(1000*prob.k.star*(0.8*dbinom(k, 10, p))+0.2*(1/11))) %>%
  uncount(weights=counts)

nLL_random <- function(beta, mu0.2_4, alph0.2_4,
                      mu0.5_4, alph0.5_4,
                      mu0.8_4, alph0.8_4,
                      mu0.2_5, alph0.2_5,
                      mu0.5_5, alph0.5_5,
                      mu0.8_5, alph0.8_5){
  k = countRandomLie$k
  kstar = countRandomLie$k.star
  expt = countRandomLie$expt
  prob = countRandomLie$p
  mu = case_when(
    prob == 0.2 & expt == "expt4" ~ mu0.2_4,
    prob == 0.5 & expt == "expt4" ~ mu0.5_4,
    prob == 0.8 & expt == "expt4" ~ mu0.8_4,
    prob == 0.2 & expt == "expt5" ~ mu0.2_5,
    prob == 0.5 & expt == "expt5" ~ mu0.5_5,
    prob == 0.8 & expt == "expt5" ~ mu0.8_5
   )
  alph = case_when(
    prob == 0.2 & expt == "expt4" ~ alph0.2_4,
    prob == 0.5 & expt == "expt4" ~ alph0.5_4,
    prob == 0.8 & expt == "expt4" ~ alph0.8_4,
    prob == 0.2 & expt == "expt5" ~ alph0.2_5,
    prob == 0.5 & expt == "expt5" ~ alph0.5_5,
    prob == 0.8 & expt == "expt5" ~ alph0.8_5
   )
  
  betas = ifelse(expt=="expt4", 1*beta, -1*beta)
  
  pred = lieLogisticBinom(k, kstar, betas, mu, alph)
  # likelihood of observed kstar for that k, given parameters
  neg.log.lik = -1*sum(log(pred))
  mus = c(mu0.2_4, mu0.5_4, mu0.8_4, mu0.2_5, mu0.5_5, mu0.8_5)
  alphas = c(alph0.2_4, alph0.5_4, alph0.8_4, alph0.2_5, alph0.5_5, alph0.8_5)
  #neg.log.prior = sum(.0001*(mus-5)^2)-abs(beta)+ sum(alphas^2)+u*10
  neg.log.prior = 0
  neg.log.lik+neg.log.prior
}



fit_random <- summary(mle(nLL_random,
           start=list(beta=rnorm(1, 0, 0.5),
                      mu0.2_4=rnorm(1, 5, 3),
                      alph0.2_4=rnorm(1, 0, 0.5),
                      mu0.5_4=rnorm(1, 5, 3),
                      alph0.5_4=rnorm(1, 0, 0.5),
                      mu0.8_4=rnorm(1, 5, 3),
                      alph0.8_4=rnorm(1, 0, 0.5),
                      mu0.2_5=rnorm(1, 5, 3),
                      alph0.2_5=rnorm(1, 0, 0.5),
                      mu0.5_5=rnorm(1, 5, 3),
                      alph0.5_5=rnorm(1, 0, 0.5),
                      mu0.8_5=rnorm(1, 5, 3),
                      alph0.8_5=rnorm(1, 0, 0.5)),
           method = "BFGS"))
fit_random

lieMLE.pred_random <- data.frame(k=rep(rep(0:10,each=11),3*2), 
                          kstar=rep(0:10, 11*3*2),
                          p=as.factor(rep(c(rep(0.2,11*11), rep(0.5,11*11), rep(0.8,11*11)),2)),
                          expt=as.factor(c(rep("expt4",11*11*3), rep("expt5",11*11*3))),
                          alph=c(rep(fit_random@coef["alph0.2_4","Estimate"],11*11),
                                 rep(fit_random@coef["alph0.5_4","Estimate"],11*11),
                                 rep(fit_random@coef["alph0.8_4","Estimate"],11*11),
                                 rep(fit_random@coef["alph0.2_5","Estimate"],11*11),
                                 rep(fit_random@coef["alph0.5_5","Estimate"],11*11),
                                 rep(fit_random@coef["alph0.8_5","Estimate"],11*11)),
                          alph.se=c(rep(fit_random@coef["alph0.2_4","Std. Error"],11*11),
                                    rep(fit_random@coef["alph0.5_4","Std. Error"],11*11),
                                    rep(fit_random@coef["alph0.8_4","Std. Error"],11*11),
                                    rep(fit_random@coef["alph0.2_5","Std. Error"],11*11),
                                    rep(fit_random@coef["alph0.5_5","Std. Error"],11*11),
                                    rep(fit_random@coef["alph0.8_5","Std. Error"],11*11))) %>%
  mutate(p.kstar.k = p.kstar.k(k, kstar, alph),
         binom.kstar = binom.p(kstar, alph),
         alph.asProb = logitToProb(alph))

ggplot(lieMLE.pred_random, aes(x=kstar, y=binom.kstar, colour=p)) +
  geom_line() +
  facet_grid(expt~.)
```

```{r}
lieMLE.pred <- lieMLE.pred %>%
  mutate(model="Human")
lieMLE.pred_recurse <- lieMLE.pred_recurse %>%
  mutate(model="Recursive")
lieMLE.pred_random <- lieMLE.pred_random %>%
  mutate(model="Random Opponent")

lieMLE.pred_all <- bind_rows(lieMLE.pred, lieMLE.pred_recurse, lieMLE.pred_random) %>%
  mutate(p = paste("p =", p),
         expt=factor(ifelse(expt=="expt4", "Red Payoff", "Blue Payoff"), levels=c("Red Payoff", "Blue Payoff")),
         model=factor(model, levels=c("Random Opponent", "Recursive", "Human")))


lieMLE.pred_human <- lieMLE.pred_all %>%
  filter(model == "Human") %>%
  select(p, expt, alph, alph.se, model) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph),
         meanAlph.se = 10*logitToProb(alph.se),
         lowerMeanAlph = 10*logitToProb(alph-1.96*alph.se),
         upperMeanAlph = 10*logitToProb(alph+1.96*alph.se))


lieMLE.pred_human




lieMLE.pred_all %>%
  select(p, expt, alph, alph.se, model) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(data=lieMLE.pred_human, aes(x=expt, fill=p, min=lowerMeanAlph, max=upperMeanAlph), width=.3, position=position_dodge(.9)) +
  scale_x_discrete("Utility") +
  scale_y_continuous("Average Lie", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0,0,0.5)) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  facet_grid(model~.) +
  theme_bw()

ggsave("img/liekparameter.pdf", units="cm", height=13, width=8.7)
```

```{r}
liePred_random <- lieMLE.pred_all %>%
  filter(model == "Random Opponent") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge") +
  ggtitle("a) Random Opponent Model") +
  scale_x_discrete("") +
  scale_y_continuous("Sender Mean Lie Reported", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

liePred_recurse <- lieMLE.pred_all %>%
  filter(model == "Recursive") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge") +
  ggtitle("b) Recursive ToM Model") +
  scale_x_discrete("") +
  scale_y_continuous("", limits=c(0,10), labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

liePred_human <- lieMLE.pred_all %>%
  filter(model == "Human") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(data=lieMLE.pred_human, aes(x=expt, fill=p, min=lowerMeanAlph, max=upperMeanAlph), width=.3, position=position_dodge(.9)) +
  ggtitle("c) Human Results") +
  scale_x_discrete("") +
  scale_y_continuous("", limits=c(0,10), labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values = condColors.diff) +
  guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

legend_lie <- get_legend(liePred_human)

liePred <- plot_grid(liePred_random,
                      liePred_recurse,
                      liePred_human + theme(legend.position="none"), 
                      nrow=1,
                      rel_widths=c(10.52, 10, 10))

liarLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.87, x=0.5, hjust=0, angle=270)
liepredrow <- plot_grid(liePred, liarLabel, nrow=1, rel_widths=c(96, 4))

withLegend_lie <- ggdraw() +
  draw_plot(liepredrow) +
  draw_plot(legend_lie, x=0.415, y=0.32)
withLegend_lie

ggsave("img/liePredictions.pdf", withLegend_lie, units="cm", height=5.5, width=17.8)
```

```{r}
# VARY RED
sender_points_label = c(
  "Red Payoff" = "Sender gets\npoints for red",
  "Blue Payoff" = "Sender gets\npoints for blue"
)

liePred_random <- lieMLE.pred_all %>%
  filter(model == "Random Opponent") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge", colour=outlinecolor, size=strokesize) +
  ggtitle("a) Random Opponent Model") +
  scale_x_discrete("", labels=sender_points_label) +
  scale_y_continuous("Sender Mean Lie (# Red Reported)", limits=c(0,10), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values=my_red, labels=p_label) +
  #scale_fill_brewer(palette="Reds") +
  #guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

liePred_recurse <- lieMLE.pred_all %>%
  filter(model == "Recursive") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge", colour=outlinecolor, size=strokesize) +
  ggtitle("b) Recursive ToM Model") +
  scale_x_discrete("", labels=sender_points_label) +
  scale_y_continuous("", limits=c(0,10), labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values = my_red, labels=p_label) +
  #guides(fill=guide_legend(title="", override.aes=list(size=2.5))) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

liePred_human <- lieMLE.pred_all %>%
  filter(model == "Human") %>%
  select(p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(meanAlph = 10*logitToProb(alph)) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_bar(stat="identity", position="dodge", colour=outlinecolor, size=strokesize) +
  geom_errorbar(data=lieMLE.pred_human, aes(x=expt, fill=p, min=lowerMeanAlph, max=upperMeanAlph), width=.3, position=position_dodge(.9)) +
  ggtitle("c) Human Results") +
  scale_x_discrete("", labels=sender_points_label) +
  scale_y_continuous("", limits=c(0,10), labels=rep("",6), breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_fill_manual(values = my_red, labels=p_label) +
  guides(fill=guide_legend(title="Base Rate", override.aes=list(size=0.25))) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

legend_lie <- get_legend(liePred_human)

liePred <- plot_grid(liePred_random,
                      liePred_recurse,
                      liePred_human + theme(legend.position="none"), 
                      nrow=1,
                      rel_widths=c(10.52, 10, 10))

liarLabel <- ggdraw() +
  draw_label("", fontface="bold", size=12, y=0.87, x=0.5, hjust=0, angle=270)
liepredrow <- plot_grid(liePred, liarLabel, nrow=1, rel_widths=c(96, 4))

withLegend_lie <- ggdraw() +
  draw_plot(liepredrow) +
  draw_plot(legend_lie, x=0.415, y=0.27)
withLegend_lie

ggsave("img/liePredictions_reds4.pdf", withLegend_lie, units="cm", height=5.5, width=17.8)
```

```{r}

liePred_indiv <- indiv.sender %>%
  select(subj, p, expt, alph, alph.se) %>%
  unique() %>%
  mutate(p_expt = paste0(p, "_", expt),
         p = as.factor(paste("p =", p)),
         meanAlph = 10*logitToProb(alph),
         expt = factor(ifelse(expt == "expt4", "Red Payoff", "Blue Payoff"), levels=c("Red Payoff", "Blue Payoff"))) %>%
  ggplot(aes(x=expt, y=meanAlph, fill=p)) +
  geom_dotplot(binaxis = "y", binwidth=0.15, stackdir = "center", alpha=0.4, position="dodge") +
  geom_pointrange(aes(fill=p),
                  stat="summary", 
                  fun.data = "mean_se", 
                  position =  position_dodge(width = 0.9), 
                  shape=21,
                  size=0.5) +
  ggtitle("c) Human Results") +
  scale_x_discrete("", labels=sender_points_label) +
  scale_y_continuous("", limits=c(0,10), labels=rep("",6), breaks=seq(0,10,2), expand=c(0,0)) +
  scale_fill_manual("Base Rate", values=my_red, labels=base_rate_label) +
  theme_minimal() +
  theme(legend.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.key.size = unit(0.36, 'cm'),
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold"),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))

liePred.indiv <- plot_grid(liePred_random,
                      liePred_recurse,
                      liePred_indiv + theme(legend.position="none"), 
                      nrow=1,
                      rel_widths=c(10.52, 10, 10))


liepredrow <- plot_grid(liePred.indiv, liarLabel, nrow=1, rel_widths=c(96, 4))

withLegend_lie <- ggdraw() +
  draw_plot(liepredrow) +
  draw_plot(legend_lie, x=0.415, y=0.38)
withLegend_lie

ggsave("img/liePredictions_indiv.pdf", withLegend_lie, units="cm", height=9.5, width=17.8)
```












```{r}
detect.recurse.nomoral_expt5 <- df.unif %>%
  filter(role=="Detector", mor==0, expt=="expt5") %>%
  mutate(p = paste("p =", p)) %>%
  ggplot(aes(x=ks, y=val, colour=p)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.recurse.nomoral_expt5
ggsave("img/modelRecurse_detect_nomoral_expt5.png", detect.recurse.nomoral_expt5, height=8, width=7.5)


moral = 0
Expt = 5
detect0.2idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.2, lie0.2idiot)
detect0.5idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.5, lie0.5idiot)
detect0.8idiot.nomoral_expt5 <- mapply(p.D_bs.ksay.r, 0:numMarbles, 0.8, lie0.8idiot)

detect.respondToIdiot.nomoral_expt5 <- data.frame(p=c(rep(0.2,11), rep(0.5,11), rep(0.8,11)),
           ksay=rep(0:10,3),
           bs=c(detect0.2idiot_expt5, detect0.5idiot_expt5, detect0.8idiot_expt5)) %>%
  mutate(probabilityRed.txt = paste("p =", p)) %>%
  ggplot(aes(x=ksay, y=bs, colour=probabilityRed.txt)) +
  geom_line(size=lineSize, alpha=alphaLine) +
  # scale_x_continuous("", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  # scale_y_continuous("", labels=rep("",5), limits=c(0,1), expand=c(0,0)) +
  scale_x_continuous("Reported Marbles", breaks=c(0,2,4,6,8,10), expand=c(0,0)) +
  scale_y_continuous("Proportion BS Called", limits=c(0,1), expand=c(0,0)) +
  scale_colour_manual(values=condColors.diff)+
  theme_minimal() +
  theme(legend.position = "none",
        plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize),
        axis.title = element_text(size=axisTitleSize),
        axis.text = element_text(size=axisTextSize),
        axis.text.x = element_text(margin=marginAxisX),
        axis.text.y = element_text(margin=margin(0,-1,0,-2.5)),
        axis.line = element_line(size=axisLineSize, colour=axisLineColour))
detect.respondToIdiot.nomoral_expt5
ggsave("img/modelRespondToIdiot_detect_nomoral_expt5.png", detect.respondToIdiot.nomoral_expt5, height=8, width=7.5)  


detectplots_nomoral_expt5 <- plot_grid(detect.respondToIdiot.nomoral_expt5 + ggtitle("Random Opponent") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
                         detect.recurse.nomoral_expt5 + ggtitle("Recursive") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         detect.results_expt4 + ggtitle("Red Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")),
                         detect.results_expt5 + ggtitle("Blue Utility") + theme(plot.margin = marginDim,
        plot.title = element_text(size=plotTitleSize, hjust = 0.5, face = "bold")), 
                         nrow=1,
                         rel_widths=c(10.72, 10, 10, 10))


detectrow_nomoral_expt5 <- plot_grid(detectplots_nomoral_expt5, detectorLabel, nrow=1, rel_widths=c(96, 4))

withLegend_nomoral_expt5 <- ggdraw() +
  draw_plot(detectrow_nomoral_expt5) +
  draw_plot(legend, x=0.415, y=0.32) 
ggsave("img/detectPredictions_expt5.png", 
       withLegend_nomoral_expt5, 
       units="cm", height=4.7, width=17.8)
```



```{r}
# Without smoothing, compute average lie
humanLie %>%
  filter(drawnRed != reportedDrawn) %>%
  nrow() / nrow(humanLie)
## 33.8% overall lie rate

humanLie %>%
  filter(drawnRed != reportedDrawn) %>%
  mutate(p = as.factor(probabilityRed)) %>%
  group_by(expt, p) %>%
  summarise(empiricalMeanLie = mean(reportedDrawn)) %>%
  left_join(select(MLEparams, p, expt, meanAlph), by=c("expt","p")) %>%
  mutate(inferredMeanLie = meanAlph) %>%
  select(-meanAlph)


```






